<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="b6sfFZ2JS42hoER_mUyRDfihbdCJv_T81PvPJY4zjM0">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"solarqiang.github.io","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"left","width":280,"display":"hide","padding":18,"offset":12,"onmobile":true},"copycode":{"enable":true,"show_result":true,"style":"flat"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":3,"unescape":false,"preload":false},"motion":{"enable":true,"async":true,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="Android Service 简介 Service 是一种可在后台执行长时间运行操作而不提供界面的应用组件。服务可由其他应用组件启动，而且即使用户切换到其他应用，服务仍将在后台继续运行。此外，组件可通过绑定到服务与之进行交互，甚至是执行进程间通信 (IPC)。例如，服务可在后台处理网络事务、播放音乐，执行文件 I&#x2F;O 或与内容提供程序进行交互。  服务分三种类型：  前台服务：执行一些">
<meta property="og:type" content="article">
<meta property="og:title" content="Service 源码分析">
<meta property="og:url" content="https://solarqiang.github.io/posts/2681383033/">
<meta property="og:site_name" content="小强的开发笔记">
<meta property="og:description" content="Android Service 简介 Service 是一种可在后台执行长时间运行操作而不提供界面的应用组件。服务可由其他应用组件启动，而且即使用户切换到其他应用，服务仍将在后台继续运行。此外，组件可通过绑定到服务与之进行交互，甚至是执行进程间通信 (IPC)。例如，服务可在后台处理网络事务、播放音乐，执行文件 I&#x2F;O 或与内容提供程序进行交互。  服务分三种类型：  前台服务：执行一些">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://solarqiang.github.io/images/2020-02-24-Service-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/startService.svg">
<meta property="og:image" content="https://solarqiang.github.io/images/2020-02-24-Service-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/bindService.svg">
<meta property="og:image" content="https://solarqiang.github.io/images/2020-02-24-Service-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/unbindService.svg">
<meta property="og:image" content="https://solarqiang.github.io/images/2020-02-24-Service-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/stopService.svg">
<meta property="og:image" content="https://solarqiang.github.io/images/2020-02-24-Service-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/restartService.svg">
<meta property="article:published_time" content="2020-02-23T16:00:00.000Z">
<meta property="article:modified_time" content="2024-01-09T17:38:09.316Z">
<meta property="article:author" content="solarqiang">
<meta property="article:tag" content="Android">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://solarqiang.github.io/images/2020-02-24-Service-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/startService.svg">

<link rel="canonical" href="https://solarqiang.github.io/posts/2681383033/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Service 源码分析 | 小强的开发笔记</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">小强的开发笔记</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://solarqiang.github.io/posts/2681383033/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="solarqiang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小强的开发笔记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Service 源码分析
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-02-24 00:00:00" itemprop="dateCreated datePublished" datetime="2020-02-24T00:00:00+08:00">2020-02-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-01-10 01:38:09" itemprop="dateModified" datetime="2024-01-10T01:38:09+08:00">2024-01-10</time>
              </span>

          
            <span id="/posts/2681383033/" class="post-meta-item leancloud_visitors" data-flag-title="Service 源码分析" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="Android-Service-简介"><a href="#Android-Service-简介" class="headerlink" title="Android Service 简介"></a>Android Service 简介</h1><blockquote>
<p>Service 是一种可在后台执行长时间运行操作而不提供界面的应用组件。服务可由其他应用组件启动，而且即使用户切换到其他应用，服务仍将在后台继续运行。此外，组件可通过绑定到服务与之进行交互，甚至是执行进程间通信 (IPC)。例如，服务可在后台处理网络事务、播放音乐，执行文件 I&#x2F;O 或与内容提供程序进行交互。</p>
</blockquote>
<p>服务分三种类型：</p>
<ol>
<li>前台服务：执行一些用户能注意到的操作，如播放音乐。前台服务必须显示通知。</li>
<li>后台服务：执行用户不会直接注意到的操作。</li>
<li>绑定服务：应用组件通过调用 <code>bindService</code> 绑定到服务。绑定服务提供客户端-服务器接口，以便组件与服务进行交互。绑定服务仅当应用组件绑定时才会启动，当全部绑定被取消时，服务会被销毁。</li>
</ol>
<p>服务可以既是启动服务（通过 <code>startService</code> 启动）又是绑定服务（通过 <code>bindService</code> 启动），取决于是否实现 <code>onStartCommand()</code> 和 <code>onBind()</code> 回调方法。</p>
<span id="more"></span>

<h2 id="创建服务"><a href="#创建服务" class="headerlink" title="创建服务"></a>创建服务</h2><p>如要创建服务，必须创建或使用 Service 类的子类。在实现中，必须实现一些处理服务生命周期的回调方法：</p>
<ul>
<li><code>onStartCommand()</code>: 当另一个组件通过 <code>startService</code> 请求启动服务时，系统会调用该方法。通过该方法调用的服务可以无限期运行。服务可以通过 <code>stopSelf()</code> 来自行停止运行。</li>
<li><code>onBind()</code>: 当另一组件通过 <code>bindService</code> 与服务绑定时，系统会调用该方法。该方法必须返回一个 <code>IBinder</code> 接口，以供客户端与服务通信。</li>
<li><code>onCreate()</code>: 首次创建服务时，系统会在调用 <code>onStartCommand()</code> 或 <code>onBind()</code> 前调用此方法。如果服务已在运行，则不会调用此方法。</li>
<li><code>onDestroy()</code>: 当不在使用服务并准备将其销毁时，系统会调用该方法。</li>
</ul>
<p>创建服务后，还必须在应用清单文件中声明所有服务。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">...</span> &gt;</span></span><br><span class="line">  ...</span><br><span class="line">  <span class="tag">&lt;<span class="name">application</span> <span class="attr">...</span> &gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">service</span> <span class="attr">android:name</span>=<span class="string">&quot;.ExampleService&quot;</span> /&gt;</span></span><br><span class="line">      ...</span><br><span class="line">  <span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="绑定到服务"><a href="#绑定到服务" class="headerlink" title="绑定到服务"></a>绑定到服务</h2><p>调用 <code>bindService(Intent, ServiceConnection, int)</code> 方法的组件必须实现 ServiceConnection 接口并将其传入 <code>bindService</code>。当应用组件调用 <code>bindService</code> 方法，系统将服务端 <code>onBind</code> 方法返回的 IBinder 对象传入 <code>ServiceConnection.onServiceConnected(ComponentName, IBinder)</code> 回调。客户端组件可通过此 IBinder 对象与客户端进行通信。</p>
<p>如果需要创建尚未处于活动状态的服务，则必须在 <code>flag</code> 参数中设置 <code>BIND_AUTO_CREATE</code> 标志，否则只能绑定到已经启动的服务。</p>
<h2 id="服务生命周期"><a href="#服务生命周期" class="headerlink" title="服务生命周期"></a>服务生命周期</h2><ol>
<li>通过 <code>startService</code> 方法启动的服务：<ol>
<li>除非通过 <code>stopService</code> 方法或服务自身调用 <code>stopSelf</code> 方法，将会无限期保持运行，即使进程被杀死也会重新启动；</li>
<li>如果运行过程中接收过 <code>bindService</code> 方法调用，必须等待所有设置 <code>BIND_AUTO_CREATE</code> 标志的客户端解绑，<code>stopService</code> 才会停止服务；</li>
</ol>
</li>
<li>通过 <code>bindService</code> 方法启动的服务：<ol>
<li>在所有 <code>bindService</code> 的客户端都调用 <code>unbindService</code> 解绑之后自动停止；</li>
<li>如果运行过程中接收过 <code>startService</code> 调用，必须调用 <code>stopService</code> 才会停止。</li>
</ol>
</li>
</ol>
<p>总结：<code>startService</code> 与 <code>stopService</code> 配对，<code>bindService</code> 与 <code>unbindService</code> 配对，只有完成配对，服务才会停止运行，除非调用 <code>stopService</code> 时所有活跃绑定都没有设置 <code>BIND_AUTO_CREATE</code>。详细说明参照 <a href="#service-%E5%81%9C%E6%AD%A2%E6%B5%81%E7%A8%8B">Service 停止流程</a>。</p>
<p>PS：<code>stopSelf</code> 方法的限制与 <code>stopService</code> 相同。</p>
<h1 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h1><h2 id="Service-启动流程"><a href="#Service-启动流程" class="headerlink" title="Service 启动流程"></a>Service 启动流程</h2><p><img src="/images/2020-02-24-Service-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/startService.svg" alt="Service 启动流程"></p>
<p>我们从 <code>startService(Intent)</code> 方法开始分析。这个方法的实现在 ContextImpl 类中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ComponentName <span class="title function_">startService</span><span class="params">(Intent service)</span> &#123;</span><br><span class="line">    warnIfCallingFromSystemProcess();</span><br><span class="line">    <span class="keyword">return</span> startServiceCommon(service, <span class="literal">false</span>, mUser);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>startForegroundService(Intent)</code> 方法与之几乎相同，除了调用 <code>startServiceCommon</code> 的第二个参数 <code>requireForeground</code> 为 <code>true</code>。</p>
<p><code>startServiceCommon</code> 对 Intent 进行检查，之后调用 AMS 的 <code>startService</code> 方法；</p>
<p><code>AMS.startService</code> 方法检查文件描述符泄漏和调用者之后，调用 <code>ActiveServices.startServiceLocked</code> 方法。</p>
<h3 id="startServiceLocked"><a href="#startServiceLocked" class="headerlink" title="startServiceLocked"></a><code>startServiceLocked</code></h3><p><code>com.android.server.am.ActiveServices</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">ComponentName <span class="title function_">startServiceLocked</span><span class="params">(IApplicationThread caller, Intent service, String resolvedType,</span></span><br><span class="line"><span class="params">        <span class="type">int</span> callingPid, <span class="type">int</span> callingUid, <span class="type">boolean</span> fgRequired, String callingPackage,</span></span><br><span class="line"><span class="params">        <span class="keyword">final</span> <span class="type">int</span> userId, <span class="type">boolean</span> allowBackgroundActivityStarts)</span></span><br><span class="line">        <span class="keyword">throws</span> TransactionTooLargeException &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> callerFg;</span><br><span class="line">    ...... <span class="comment">// 判断调用者是否在前台</span></span><br><span class="line"></span><br><span class="line">    <span class="type">ServiceLookupResult</span> <span class="variable">res</span> <span class="operator">=</span></span><br><span class="line">        retrieveServiceLocked(service, <span class="literal">null</span>, resolvedType, callingPackage,</span><br><span class="line">                callingPid, callingUid, userId, <span class="literal">true</span>, callerFg, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">if</span> (res == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (res.record == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ComponentName</span>(<span class="string">&quot;!&quot;</span>, res.permission != <span class="literal">null</span></span><br><span class="line">                ? res.permission : <span class="string">&quot;private to package&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">ServiceRecord</span> <span class="variable">r</span> <span class="operator">=</span> res.record;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!mAm.mUserController.exists(r.userId)) &#123;...; <span class="keyword">return</span> nulll;&#125;</span><br></pre></td></tr></table></figure>

<p>这一节做的事情有：</p>
<ol>
<li>判断调用者是否在前台；</li>
<li>调用 <code>retrieveServiceLocked</code> 方法解析 <code>service</code> 这个 Intent，得到 ServiceLookupResult，从中取得 ServiceRecord；</li>
<li>处理这个服务记录的用户不存在的情况。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// If we&#x27;re starting indirectly (e.g. from PendingIntent), figure out whether</span></span><br><span class="line"><span class="comment">// we&#x27;re launching into an app in a background state.  This keys off of the same</span></span><br><span class="line"><span class="comment">// idleness state tracking as e.g. O+ background service start policy.</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">bgLaunch</span> <span class="operator">=</span> !mAm.isUidActiveLocked(r.appInfo.uid);</span><br><span class="line"></span><br><span class="line"><span class="comment">// If the app has strict background restrictions, we treat any bg service</span></span><br><span class="line"><span class="comment">// start analogously to the legacy-app forced-restrictions case, regardless</span></span><br><span class="line"><span class="comment">// of its target SDK version.</span></span><br><span class="line"><span class="type">boolean</span> <span class="variable">forcedStandby</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">if</span> (bgLaunch &amp;&amp; appRestrictedAnyInBackground(r.appInfo.uid, r.packageName)) &#123;</span><br><span class="line">    ...</span><br><span class="line">    forcedStandby = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// If this is a direct-to-foreground start, make sure it is allowed as per the app op.</span></span><br><span class="line"><span class="type">boolean</span> <span class="variable">forceSilentAbort</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">if</span> (fgRequired) &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">mode</span> <span class="operator">=</span> mAm.mAppOpsService.checkOperation(</span><br><span class="line">            AppOpsManager.OP_START_FOREGROUND, r.appInfo.uid, r.packageName);</span><br><span class="line">    <span class="keyword">switch</span> (mode) &#123;</span><br><span class="line">        <span class="keyword">case</span> AppOpsManager.MODE_ALLOWED:</span><br><span class="line">        <span class="keyword">case</span> AppOpsManager.MODE_DEFAULT:</span><br><span class="line">            <span class="comment">// All okay.</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> AppOpsManager.MODE_IGNORED:</span><br><span class="line">            <span class="comment">// Not allowed, fall back to normal start service, failing siliently</span></span><br><span class="line">            <span class="comment">// if background check restricts that.</span></span><br><span class="line">            ...</span><br><span class="line">            fgRequired = <span class="literal">false</span>;</span><br><span class="line">            forceSilentAbort = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ComponentName</span>(<span class="string">&quot;!!&quot;</span>, <span class="string">&quot;foreground not allowed as per app op&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// If this isn&#x27;t a direct-to-foreground start, check our ability to kick off an</span></span><br><span class="line"><span class="comment">// arbitrary service</span></span><br><span class="line"><span class="keyword">if</span> (forcedStandby || (!r.startRequested &amp;&amp; !fgRequired)) &#123;</span><br><span class="line">    <span class="comment">// Before going further -- if this app is not allowed to start services in the</span></span><br><span class="line">    <span class="comment">// background, then at this point we aren&#x27;t going to let it period.</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">allowed</span> <span class="operator">=</span> mAm.getAppStartModeLocked(r.appInfo.uid, r.packageName,</span><br><span class="line">            r.appInfo.targetSdkVersion, callingPid, <span class="literal">false</span>, <span class="literal">false</span>, forcedStandby);</span><br><span class="line">    <span class="keyword">if</span> (allowed != ActivityManager.APP_START_MODE_NORMAL) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> (allowed == ActivityManager.APP_START_MODE_DELAYED || forceSilentAbort) &#123;</span><br><span class="line">            <span class="comment">// In this case we are silently disabling the app, to disrupt as</span></span><br><span class="line">            <span class="comment">// little as possible existing apps.</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (forcedStandby) &#123;</span><br><span class="line">            <span class="comment">// This is an O+ app, but we might be here because the user has placed</span></span><br><span class="line">            <span class="comment">// it under strict background restrictions.  Don&#x27;t punish the app if it&#x27;s</span></span><br><span class="line">            <span class="comment">// trying to do the right thing but we&#x27;re denying it for that reason.</span></span><br><span class="line">            <span class="keyword">if</span> (fgRequired) &#123;</span><br><span class="line">                ...</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// This app knows it is in the new model where this operation is not</span></span><br><span class="line">        <span class="comment">// allowed, so tell it what has happened.</span></span><br><span class="line">        <span class="type">UidRecord</span> <span class="variable">uidRec</span> <span class="operator">=</span> mAm.mProcessList.getUidRecordLocked(r.appInfo.uid);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ComponentName</span>(<span class="string">&quot;?&quot;</span>, <span class="string">&quot;app is in background uid &quot;</span> + uidRec);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// At this point we&#x27;ve applied allowed-to-start policy based on whether this was</span></span><br><span class="line"><span class="comment">// an ordinary startService() or a startForegroundService().  Now, only require that</span></span><br><span class="line"><span class="comment">// the app follow through on the startForegroundService() -&gt; startForeground()</span></span><br><span class="line"><span class="comment">// contract if it actually targets O+.</span></span><br><span class="line"><span class="keyword">if</span> (r.appInfo.targetSdkVersion &lt; Build.VERSION_CODES.O &amp;&amp; fgRequired) &#123;</span><br><span class="line">    ...</span><br><span class="line">    fgRequired = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">NeededUriGrants</span> <span class="variable">neededGrants</span> <span class="operator">=</span> mAm.mUgmInternal.checkGrantUriPermissionFromIntent(</span><br><span class="line">        callingUid, r.packageName, service, service.getFlags(), <span class="literal">null</span>, r.userId);</span><br><span class="line"></span><br><span class="line"><span class="comment">// If permissions need a review before any of the app components can run,</span></span><br><span class="line"><span class="comment">// we do not start the service and launch a review activity if the calling app</span></span><br><span class="line"><span class="comment">// is in the foreground passing it a pending intent to start the service when</span></span><br><span class="line"><span class="comment">// review is completed.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// XXX This is not dealing with fgRequired!</span></span><br><span class="line"><span class="keyword">if</span> (!requestStartTargetPermissionsReviewIfNeededLocked(r, callingPackage,</span><br><span class="line">        callingUid, service, callerFg, userId)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>进行一系列与后台启动限制相关的检查。TODO</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">r.lastActivity = SystemClock.uptimeMillis();</span><br><span class="line">r.startRequested = <span class="literal">true</span>;</span><br><span class="line">r.delayedStop = <span class="literal">false</span>;</span><br><span class="line">r.fgRequired = fgRequired;</span><br><span class="line">r.pendingStarts.add(<span class="keyword">new</span> <span class="title class_">ServiceRecord</span>.StartItem(r, <span class="literal">false</span>, r.makeNextStartId(),</span><br><span class="line">        service, neededGrants, callingUid));</span><br></pre></td></tr></table></figure>

<p>设置 ServiceRecord，新建 StartItem 加入到其 pendingStarts 列表。这个列表包含了准备发送给服务以执行其 <code>onStartCommand</code> 方法的的参数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (fgRequired) &#123;</span><br><span class="line">    <span class="comment">// We are now effectively running a foreground service.</span></span><br><span class="line">    ...</span><br><span class="line">    mAm.mAppOpsService.startOperation(AppOpsManager.getToken(mAm.mAppOpsService),</span><br><span class="line">            AppOpsManager.OP_START_FOREGROUND, r.appInfo.uid, r.packageName, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果要启动前台服务，调用 <code>AppOpsService.startOperation</code> 方法 TODO</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">final</span> <span class="type">ServiceMap</span> <span class="variable">smap</span> <span class="operator">=</span> getServiceMapLocked(r.userId);</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">addToStarting</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (!callerFg &amp;&amp; !fgRequired &amp;&amp; r.app == <span class="literal">null</span></span><br><span class="line">            &amp;&amp; mAm.mUserController.hasStartedUserState(r.userId)) &#123;</span><br><span class="line">        <span class="type">ProcessRecord</span> <span class="variable">proc</span> <span class="operator">=</span> mAm.getProcessRecordLocked(r.processName, r.appInfo.uid, <span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">if</span> (proc == <span class="literal">null</span> || proc.getCurProcState() &gt; ActivityManager.PROCESS_STATE_RECEIVER) &#123;</span><br><span class="line">            <span class="comment">// If this is not coming from a foreground caller, then we may want</span></span><br><span class="line">            <span class="comment">// to delay the start if there are already other background services</span></span><br><span class="line">            <span class="comment">// that are starting.  This is to avoid process start spam when lots</span></span><br><span class="line">            <span class="comment">// of applications are all handling things like connectivity broadcasts.</span></span><br><span class="line">            <span class="comment">// We only do this for cached processes, because otherwise an application</span></span><br><span class="line">            <span class="comment">// can have assumptions about calling startService() for a service to run</span></span><br><span class="line">            <span class="comment">// in its own process, and for that process to not be killed before the</span></span><br><span class="line">            <span class="comment">// service is started.  This is especially the case for receivers, which</span></span><br><span class="line">            <span class="comment">// may start a service in onReceive() to do some additional work and have</span></span><br><span class="line">            <span class="comment">// initialized some global state as part of that.</span></span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">if</span> (r.delayed) &#123;</span><br><span class="line">                <span class="comment">// This service is already scheduled for a delayed start; just leave</span></span><br><span class="line">                <span class="comment">// it still waiting.</span></span><br><span class="line">                <span class="keyword">return</span> r.name;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (smap.mStartingBackground.size() &gt;= mMaxStartingBackground) &#123;</span><br><span class="line">                <span class="comment">// Something else is starting, delay!</span></span><br><span class="line">                ...</span><br><span class="line">                smap.mDelayedStartList.add(r);</span><br><span class="line">                r.delayed = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">return</span> r.name;</span><br><span class="line">            &#125;</span><br><span class="line">            ...</span><br><span class="line">            addToStarting = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (proc.getCurProcState() &gt;= ActivityManager.PROCESS_STATE_SERVICE) &#123;</span><br><span class="line">            <span class="comment">// We slightly loosen when we will enqueue this new service as a background</span></span><br><span class="line">            <span class="comment">// starting service we are waiting for, to also include processes that are</span></span><br><span class="line">            <span class="comment">// currently running other services or receivers.</span></span><br><span class="line">            addToStarting = <span class="literal">true</span>;</span><br><span class="line">            ...</span><br><span class="line">        &#125; ...</span><br><span class="line">    &#125; ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (allowBackgroundActivityStarts) &#123;</span><br><span class="line">        r.whitelistBgActivityStartsOnServiceStart();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">ComponentName</span> <span class="variable">cmp</span> <span class="operator">=</span> startServiceInnerLocked(smap, service, r, callerFg, addToStarting);</span><br><span class="line">    <span class="keyword">return</span> cmp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>如果服务对应进程没有启动，或者正在处理接收器，延迟启动服务，以避免大量服务同时启动：<ol>
<li>如果已经设置延迟启动，直接返回；</li>
<li>如果正在后台启动的服务 <code>smap.mStartingBackground</code> 大于上限，将当前启动服务记录设为延迟启动，并加入延迟启动清单 <code>smap.mDelayedStartList</code>，最后返回；</li>
</ol>
</li>
<li>没有延迟启动的，调用 <code>startServiceInnerLocked</code> 继续服务启动的流程。</li>
</ol>
<h3 id="startServiceInnerLocked"><a href="#startServiceInnerLocked" class="headerlink" title="startServiceInnerLocked"></a><code>startServiceInnerLocked</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">ComponentName <span class="title function_">startServiceInnerLocked</span><span class="params">(ServiceMap smap, Intent service, ServiceRecord r,</span></span><br><span class="line"><span class="params">        <span class="type">boolean</span> callerFg, <span class="type">boolean</span> addToStarting)</span> <span class="keyword">throws</span> TransactionTooLargeException &#123;</span><br><span class="line">    ...</span><br><span class="line">    r.callStart = <span class="literal">false</span>;</span><br><span class="line">    ...</span><br><span class="line">    <span class="type">String</span> <span class="variable">error</span> <span class="operator">=</span> bringUpServiceLocked(r, service.getFlags(), callerFg, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">if</span> (error != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ComponentName</span>(<span class="string">&quot;!!&quot;</span>, error);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r.startRequested &amp;&amp; addToStarting) &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">first</span> <span class="operator">=</span> smap.mStartingBackground.size() == <span class="number">0</span>;</span><br><span class="line">        smap.mStartingBackground.add(r);</span><br><span class="line">        r.startingBgTimeout = SystemClock.uptimeMillis() + mAm.mConstants.BG_START_TIMEOUT;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> (first) &#123;</span><br><span class="line">            smap.rescheduleDelayedStartsLocked();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (callerFg || r.fgRequired) &#123;</span><br><span class="line">        smap.ensureNotStartingBackgroundLocked(r);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> r.name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>更新 ServiceRecord 的状态，调用 <code>bringUpServiceLocked</code> 拉起服务。</p>
<p>后台启动限制：TODO</p>
<h3 id="bringUpServiceLocked"><a href="#bringUpServiceLocked" class="headerlink" title="bringUpServiceLocked"></a><code>bringUpServiceLocked</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> String <span class="title function_">bringUpServiceLocked</span><span class="params">(ServiceRecord r, <span class="type">int</span> intentFlags, <span class="type">boolean</span> execInFg,</span></span><br><span class="line"><span class="params">        <span class="type">boolean</span> whileRestarting, <span class="type">boolean</span> permissionsReviewRequired)</span></span><br><span class="line">        <span class="keyword">throws</span> TransactionTooLargeException &#123;</span><br><span class="line">    <span class="keyword">if</span> (r.app != <span class="literal">null</span> &amp;&amp; r.app.thread != <span class="literal">null</span>) &#123;</span><br><span class="line">        sendServiceArgsLocked(r, execInFg, <span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!whileRestarting &amp;&amp; mRestartingServices.contains(r)) &#123;</span><br><span class="line">        <span class="comment">// If waiting for a restart, then do nothing.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// We are now bringing the service up, so no longer in the</span></span><br><span class="line">    <span class="comment">// restarting state.</span></span><br><span class="line">    <span class="keyword">if</span> (mRestartingServices.remove(r)) &#123;</span><br><span class="line">        clearRestartingIfNeededLocked(r);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Make sure this service is no longer considered delayed, we are starting it now.</span></span><br><span class="line">    <span class="keyword">if</span> (r.delayed) &#123;</span><br><span class="line">        ...</span><br><span class="line">        getServiceMapLocked(r.userId).mDelayedStartList.remove(r);</span><br><span class="line">        r.delayed = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Make sure that the user who owns this service is started.  If not,</span></span><br><span class="line">    <span class="comment">// we don&#x27;t want to allow it to run.</span></span><br><span class="line">    <span class="keyword">if</span> (!mAm.mUserController.hasStartedUserState(r.userId)) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> ...;</span><br><span class="line">        ...</span><br><span class="line">        bringDownServiceLocked(r);</span><br><span class="line">        <span class="keyword">return</span> msg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Service is now being launched, its package can&#x27;t be stopped.</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        AppGlobals.getPackageManager().setPackageStoppedState(</span><br><span class="line">                r.packageName, <span class="literal">false</span>, r.userId);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;...&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>如果 <code>r.app != null &amp;&amp; r.app.thread != null</code>，表明此 Service 已经启动过，调用 <code>sendServiceArgsLocked</code> 方法，这个方法会执行 <code>Service.onStartCommand</code> 方法，之后返回；</li>
<li>如果 <code>!whileRestarting &amp;&amp; mRestartingServices.contains(r)</code>，服务正在等待重启，直接返回；</li>
<li>如果之前在等待重启列表，移除之，并清除正在重启状态；</li>
<li>如果之前设置延迟启动状态，移除之；</li>
<li>确认 Service 所在用户已启动，否则销毁服务；</li>
<li>设置 Service 所在 App 不可被 PackageManager 停止；</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">isolated</span> <span class="operator">=</span> (r.serviceInfo.flags&amp;ServiceInfo.FLAG_ISOLATED_PROCESS) != <span class="number">0</span>;</span><br><span class="line"><span class="keyword">final</span> <span class="type">String</span> <span class="variable">procName</span> <span class="operator">=</span> r.processName;</span><br><span class="line"><span class="type">HostingRecord</span> <span class="variable">hostingRecord</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HostingRecord</span>(<span class="string">&quot;service&quot;</span>, r.instanceName);</span><br><span class="line">ProcessRecord app;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!isolated) &#123;</span><br><span class="line">    app = mAm.getProcessRecordLocked(procName, r.appInfo.uid, <span class="literal">false</span>);</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (app != <span class="literal">null</span> &amp;&amp; app.thread != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            app.addPackage(r.appInfo.packageName, r.appInfo.longVersionCode, mAm.mProcessStats);</span><br><span class="line">            realStartServiceLocked(r, app, execInFg);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (TransactionTooLargeException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;...&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If a dead object exception was thrown -- fall through to</span></span><br><span class="line">        <span class="comment">// restart the application.</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// If this service runs in an isolated process, then each time</span></span><br><span class="line">    <span class="comment">// we call startProcessLocked() we will get a new isolated</span></span><br><span class="line">    <span class="comment">// process, starting another process if we are currently waiting</span></span><br><span class="line">    <span class="comment">// for a previous process to come up.  To deal with this, we store</span></span><br><span class="line">    <span class="comment">// in the service any current isolated process it is running in or</span></span><br><span class="line">    <span class="comment">// waiting to have come up.</span></span><br><span class="line">    app = r.isolatedProc;</span><br><span class="line">    <span class="keyword">if</span> (WebViewZygote.isMultiprocessEnabled()</span><br><span class="line">            &amp;&amp; r.serviceInfo.packageName.equals(WebViewZygote.getPackageName())) &#123;</span><br><span class="line">        hostingRecord = HostingRecord.byWebviewZygote(r.instanceName);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((r.serviceInfo.flags &amp; ServiceInfo.FLAG_USE_APP_ZYGOTE) != <span class="number">0</span>) &#123;</span><br><span class="line">        hostingRecord = HostingRecord.byAppZygote(r.instanceName, r.definingPackageName,</span><br><span class="line">                r.definingUid);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>判断服务是不是独立进程，获取 ServiceRecord 的 <code>processName</code> 属性，也就是清单中的 <code>android:process</code> 属性；</li>
<li>如果不是独立进程，通过进程名和 UID 获取对应的 ProcessRecord，检查用来启动这个 Service 的进程是否已存在，如果存在，调用 <code>realStartServiceLocked</code> 启动这个 Service 组件并返回；</li>
<li>如果是独立进程，尝试从 ServiceRecord 的 <code>isolatedProc</code> 获取当前服务的 ProcessRecord；</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">// Not running -- get it started, and enqueue this service record</span></span><br><span class="line">    <span class="comment">// to be executed when the app comes up.</span></span><br><span class="line">    <span class="keyword">if</span> (app == <span class="literal">null</span> &amp;&amp; !permissionsReviewRequired) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((app=mAm.startProcessLocked(procName, r.appInfo, <span class="literal">true</span>, intentFlags,</span><br><span class="line">                hostingRecord, <span class="literal">false</span>, isolated, <span class="literal">false</span>)) == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> ...;</span><br><span class="line">            bringDownServiceLocked(r);</span><br><span class="line">            <span class="keyword">return</span> msg;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (isolated) &#123;</span><br><span class="line">            r.isolatedProc = app;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r.fgRequired) &#123;</span><br><span class="line">        mAm.tempWhitelistUidLocked(r.appInfo.uid,</span><br><span class="line">                SERVICE_START_FOREGROUND_TIMEOUT, <span class="string">&quot;fg-service-launch&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!mPendingServices.contains(r)) &#123;</span><br><span class="line">        mPendingServices.add(r);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r.delayedStop) &#123;</span><br><span class="line">        <span class="comment">// Oh and hey we&#x27;ve already been asked to stop!</span></span><br><span class="line">        r.delayedStop = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (r.startRequested) &#123;</span><br><span class="line">            stopServiceLocked(r);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>如果用来启动服务的进程没有启动，调用 <code>AMS.startProcessLocked</code> 来启动该进程，如果启动失败则销毁服务，如果是独立进程的服务，将启动的 ProcessRecord 保存到 ServiceRecord 的 <code>isolatedProc</code> 成员；</li>
<li>如果是前台服务，加入进程到 tempWhitelist；</li>
<li>加入 ServiceRecord 到 <code>mPendingServices</code> 列表；</li>
<li>如果是延迟停止的服务，这里直接停止？TODO</li>
</ol>
<p>总结下来，这个方法最主要做了三件事：</p>
<ol>
<li>如果 Service 已经启动过，执行 <code>Service.onStartCommand</code> 方法；</li>
<li>如果此 Service 未启动，但所属进程已启动，则调用 <code>realStartServiceLocked</code> 进入真正启动 Service 的流程；</li>
<li>如果 Service 所属进程尚未启动，则先启动进程，如 app 进程启动失败则销毁此 Service ；如启动成功，则加入 <code>mPendingServices</code> 列表，待 App 进程启动结束后再启动 Service。此过程参见 <a href="#attachapplicationlocked"><code>attachApplicationLocked</code></a>。</li>
</ol>
<h3 id="realStartServiceLocked"><a href="#realStartServiceLocked" class="headerlink" title="realStartServiceLocked"></a><code>realStartServiceLocked</code></h3><p>如果 Service 所属进程已存在，启动 Service 组件。这个方法在 <code>bindService</code> 时也可能调用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">realStartServiceLocked</span><span class="params">(ServiceRecord r,</span></span><br><span class="line"><span class="params">        ProcessRecord app, <span class="type">boolean</span> execInFg)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">    <span class="keyword">if</span> (app.thread == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RemoteException</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    r.setProcess(app);</span><br><span class="line">    r.restartTime = r.lastActivity = SystemClock.uptimeMillis();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">newService</span> <span class="operator">=</span> app.services.add(r);</span><br><span class="line">    bumpServiceExecutingLocked(r, execInFg, <span class="string">&quot;create&quot;</span>);</span><br><span class="line">    mAm.updateLruProcessLocked(app, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">    updateServiceForegroundLocked(r.app, <span class="comment">/* oomAdj= */</span> <span class="literal">false</span>);</span><br><span class="line">    mAm.updateOomAdjLocked(OomAdjuster.OOM_ADJ_REASON_START_SERVICE);</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">created</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (r.stats.getBatteryStats()) &#123;</span><br><span class="line">            r.stats.startLaunchedLocked();</span><br><span class="line">        &#125;</span><br><span class="line">        mAm.notifyPackageUse(r.serviceInfo.packageName,</span><br><span class="line">                             PackageManager.NOTIFY_PACKAGE_USE_SERVICE);</span><br><span class="line">        app.forceProcessStateUpTo(ActivityManager.PROCESS_STATE_SERVICE);</span><br><span class="line">        app.thread.scheduleCreateService(r, r.serviceInfo,</span><br><span class="line">                mAm.compatibilityInfoForPackage(r.serviceInfo.applicationInfo),</span><br><span class="line">                app.getReportedProcState());</span><br><span class="line">        r.postNotification();</span><br><span class="line">        created = <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (DeadObjectException e) &#123;</span><br><span class="line">        mAm.appDiedLocked(app);</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!created) &#123;</span><br><span class="line">            <span class="comment">// Keep the executeNesting count accurate.</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">inDestroying</span> <span class="operator">=</span> mDestroyingServices.contains(r);</span><br><span class="line">            serviceDoneExecutingLocked(r, inDestroying, inDestroying);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Cleanup.</span></span><br><span class="line">            <span class="keyword">if</span> (newService) &#123;</span><br><span class="line">                app.services.remove(r);</span><br><span class="line">                r.setProcess(<span class="literal">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Retry.</span></span><br><span class="line">            <span class="keyword">if</span> (!inDestroying) &#123;</span><br><span class="line">                scheduleServiceRestartLocked(r, <span class="literal">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>向 ProcessRecord 添加这条 ServiceRecord；</li>
<li>调整 LruProcess 列表，调整进程 OomAdj，更新 ProcessRecord 中的进程状态；</li>
<li>调用 <code>ActivityThread.ApplicationThread.scheduleCreateService</code> 在目标线程初始化服务实例；</li>
<li>调用 <code>ServiceReocord.postNotification()</code>，如果是前台服务，发布通知；</li>
<li>如果服务拉起失败，做好清理，按情况尝试重启服务。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (r.whitelistManager) &#123;</span><br><span class="line">    app.whitelistManager = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">requestServiceBindingsLocked(r, execInFg);</span><br><span class="line"></span><br><span class="line">updateServiceClientActivitiesLocked(app, <span class="literal">null</span>, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (newService &amp;&amp; created) &#123;</span><br><span class="line">    app.addBoundClientUidsOfNewService(r);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// If the service is in the started state, and there are no</span></span><br><span class="line"><span class="comment">// pending arguments, then fake up one so its onStartCommand() will</span></span><br><span class="line"><span class="comment">// be called.</span></span><br><span class="line"><span class="keyword">if</span> (r.startRequested &amp;&amp; r.callStart &amp;&amp; r.pendingStarts.size() == <span class="number">0</span>) &#123;</span><br><span class="line">    r.pendingStarts.add(<span class="keyword">new</span> <span class="title class_">ServiceRecord</span>.StartItem(r, <span class="literal">false</span>, r.makeNextStartId(),</span><br><span class="line">            <span class="literal">null</span>, <span class="literal">null</span>, <span class="number">0</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sendServiceArgsLocked(r, execInFg, <span class="literal">true</span>);</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>调用 <code>requestServiceBindingsLocked</code>，准备调用 <code>onBind</code> 方法；</li>
<li>调用 <code>sendServiceArgsLocked</code>，准备调用 <code>onStartCommand</code> 方法；</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (r.delayed) &#123;</span><br><span class="line">        getServiceMapLocked(r.userId).mDelayedStartList.remove(r);</span><br><span class="line">        r.delayed = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r.delayedStop) &#123;</span><br><span class="line">        <span class="comment">// Oh and hey we&#x27;ve already been asked to stop!</span></span><br><span class="line">        r.delayedStop = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (r.startRequested) &#123;</span><br><span class="line">            stopServiceLocked(r);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>后台启动限制：<br>9. 如果之前设置了延迟启动，取消设置；<br>10. 如果之前设置延迟停止，调用 <code>stopServiceLocked</code> 停止。</p>
<h3 id="ActivityThread-handleCreateService"><a href="#ActivityThread-handleCreateService" class="headerlink" title="ActivityThread.handleCreateService"></a><code>ActivityThread.handleCreateService</code></h3><p>正如 ApplicationThread 的其他 schedule 方法，<code>scheduleCreateService</code> 将收到的传入参数打包到 <code>CreateServiceData</code> 对象，向 ActivityThread 的 Handler 发送 <code>CREATE_SERVICE</code> 消息，Handler 收到消息后调用 <code>handleCreateService</code> 方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleCreateService</span><span class="params">(CreateServiceData data)</span> &#123;</span><br><span class="line">    <span class="comment">// If we are getting ready to gc after going to the background, well</span></span><br><span class="line">    <span class="comment">// we are back active so skip it.</span></span><br><span class="line">    unscheduleGcIdler();</span><br><span class="line"></span><br><span class="line">    <span class="type">LoadedApk</span> <span class="variable">packageInfo</span> <span class="operator">=</span> getPackageInfoNoCheck(</span><br><span class="line">            data.info.applicationInfo, data.compatInfo);</span><br><span class="line">    <span class="type">Service</span> <span class="variable">service</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        java.lang.<span class="type">ClassLoader</span> <span class="variable">cl</span> <span class="operator">=</span> packageInfo.getClassLoader();</span><br><span class="line">        service = packageInfo.getAppFactory()</span><br><span class="line">                .instantiateService(cl, data.info.name, data.intent);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;...&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">ContextImpl</span> <span class="variable">context</span> <span class="operator">=</span> ContextImpl.createAppContext(<span class="built_in">this</span>, packageInfo);</span><br><span class="line">        context.setOuterContext(service);</span><br><span class="line"></span><br><span class="line">        <span class="type">Application</span> <span class="variable">app</span> <span class="operator">=</span> packageInfo.makeApplication(<span class="literal">false</span>, mInstrumentation);</span><br><span class="line">        service.attach(context, <span class="built_in">this</span>, data.info.name, data.token, app,</span><br><span class="line">                ActivityManager.getService());</span><br><span class="line">        service.onCreate();</span><br><span class="line">        mServices.put(data.token, service);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ActivityManager.getService().serviceDoneExecuting(</span><br><span class="line">                    data.token, SERVICE_DONE_EXECUTING_ANON, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;...&#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;...&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>通过反射实例化了需要的 Service 对象；</li>
<li>创建用于 Service 的 ContextImpl 对象，获取 Application 对象，调用 <code>Service.attach</code> 方法进行绑定；</li>
<li>调用 <code>Service.onCreate()</code> 方法；</li>
<li>记录服务到 <code>mServices</code> 成员；</li>
<li>最后调用 <code>AMS.serviceDoneExecuting</code> 方法。</li>
</ol>
<h3 id="sendServiceArgsLocked"><a href="#sendServiceArgsLocked" class="headerlink" title="sendServiceArgsLocked"></a><code>sendServiceArgsLocked</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">sendServiceArgsLocked</span><span class="params">(ServiceRecord r, <span class="type">boolean</span> execInFg,</span></span><br><span class="line"><span class="params">        <span class="type">boolean</span> oomAdjusted)</span> <span class="keyword">throws</span> TransactionTooLargeException &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">N</span> <span class="operator">=</span> r.pendingStarts.size();</span><br><span class="line">    <span class="keyword">if</span> (N == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ArrayList&lt;ServiceStartArgs&gt; args = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (r.pendingStarts.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        ServiceRecord.<span class="type">StartItem</span> <span class="variable">si</span> <span class="operator">=</span> r.pendingStarts.remove(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (si.intent == <span class="literal">null</span> &amp;&amp; N &gt; <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">// If somehow we got a dummy null intent in the middle,</span></span><br><span class="line">            <span class="comment">// then skip it.  DO NOT skip a null intent when it is</span></span><br><span class="line">            <span class="comment">// the only one in the list -- this is to support the</span></span><br><span class="line">            <span class="comment">// onStartCommand(null) case.</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">        bumpServiceExecutingLocked(r, execInFg, <span class="string">&quot;start&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!oomAdjusted) &#123;</span><br><span class="line">            oomAdjusted = <span class="literal">true</span>;</span><br><span class="line">            mAm.updateOomAdjLocked(r.app, <span class="literal">true</span>, OomAdjuster.OOM_ADJ_REASON_START_SERVICE);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (r.fgRequired &amp;&amp; !r.fgWaiting) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!r.isForeground) &#123;</span><br><span class="line">                scheduleServiceForegroundTransitionTimeoutLocked(r);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                r.fgRequired = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> <span class="variable">flags</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (si.deliveryCount &gt; <span class="number">1</span>) &#123;</span><br><span class="line">            flags |= Service.START_FLAG_RETRY;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (si.doneExecutingCount &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            flags |= Service.START_FLAG_REDELIVERY;</span><br><span class="line">        &#125;</span><br><span class="line">        args.add(<span class="keyword">new</span> <span class="title class_">ServiceStartArgs</span>(si.taskRemoved, si.id, flags, si.intent));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ParceledListSlice&lt;ServiceStartArgs&gt; slice = <span class="keyword">new</span> <span class="title class_">ParceledListSlice</span>&lt;&gt;(args);</span><br><span class="line">    slice.setInlineCountLimit(<span class="number">4</span>);</span><br><span class="line">    <span class="type">Exception</span> <span class="variable">caughtException</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        r.app.thread.scheduleServiceArgs(r, slice);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (...) &#123;...&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (caughtException != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Keep nesting count correct</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">inDestroying</span> <span class="operator">=</span> mDestroyingServices.contains(r);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; args.size(); i++) &#123;</span><br><span class="line">            serviceDoneExecutingLocked(r, inDestroying, inDestroying);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (caughtException <span class="keyword">instanceof</span> TransactionTooLargeException) &#123;</span><br><span class="line">            <span class="keyword">throw</span> (TransactionTooLargeException)caughtException;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>遍历 ServiceRecord 的 <code>pendingStarts</code> 列表，取出其中需要使用的 StartItem：<ol>
<li>调用 <code>bumpServiceExecutingLocked</code> 标记开始启动服务过程；</li>
<li>将其中的 Intent 保存到 <code>args</code> 列表，最后保存到 <code>slice</code> 中，</li>
</ol>
</li>
<li>将 ServiceRecord 与之前生成的 <code>slice</code> 传入 <code>ApplicationThread.scheduleServiceArgs</code> 方法；</li>
<li>如果上一步捕获到异常，对 <code>args</code> 列表中的每个对象，调用 <code>serviceDoneExecutingLocked</code> 方法，保持计数正确（？TODO）</li>
</ol>
<p><code>ApplicationThread.scheduleServiceArgs</code> 遍历传入的 <code>args</code> 列表，向 ActivityThread 的 Handler 发送 <code>SERVICE_ARGS</code> 消息以及从 ServiceStartArgs 构建的 ServiceArgsData。Handler 接到消息后会调用 <code>handleServiceArgs</code> 方法处理。</p>
<h3 id="ActivityThread-handleServiceArgs"><a href="#ActivityThread-handleServiceArgs" class="headerlink" title="ActivityThread.handleServiceArgs"></a><code>ActivityThread.handleServiceArgs</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleServiceArgs</span><span class="params">(ServiceArgsData data)</span> &#123;</span><br><span class="line">    <span class="type">Service</span> <span class="variable">s</span> <span class="operator">=</span> mServices.get(data.token);</span><br><span class="line">    <span class="keyword">if</span> (s != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (data.args != <span class="literal">null</span>) &#123;</span><br><span class="line">                data.args.setExtrasClassLoader(s.getClassLoader());</span><br><span class="line">                data.args.prepareToEnterProcess();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">int</span> res;</span><br><span class="line">            <span class="keyword">if</span> (!data.taskRemoved) &#123;</span><br><span class="line">                res = s.onStartCommand(data.args, data.flags, data.startId);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                s.onTaskRemoved(data.args);</span><br><span class="line">                res = Service.START_TASK_REMOVED_COMPLETE;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            QueuedWork.waitToFinish();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                ActivityManager.getService().serviceDoneExecuting(</span><br><span class="line">                        data.token, SERVICE_DONE_EXECUTING_START, data.startId, res);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;...&#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;...&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>根据 <code>data.token</code>，也就是 ServiceRecord 对象从 <code>mServices</code> 获取对应的 Service 对象，这里的 Service 对象是在 <code>handleCreateService</code> 方法中创建并存入的；</li>
<li>如果没有设定 <code>taskRemoved</code> 标志，就执行 <code>Service.onStartCommand</code> 方法，否则执行 <code>Service.onTaskRemoved</code> 方法；</li>
<li>等待 QueuedWork 队列完成，调用 <code>AMS.serviceDoneExecuting</code>，这个方法调用 <code>ActiveServices.serviceDoneExecutingLocked</code> 方法。</li>
</ol>
<h3 id="bumpServiceExecutingLocked"><a href="#bumpServiceExecutingLocked" class="headerlink" title="bumpServiceExecutingLocked"></a><code>bumpServiceExecutingLocked</code></h3><p>处理服务启动超时，调用 <code>scheduleServiceTimeoutLocked</code>。TODO</p>
<h3 id="serviceDoneExecutingLocked"><a href="#serviceDoneExecutingLocked" class="headerlink" title="serviceDoneExecutingLocked"></a><code>serviceDoneExecutingLocked</code></h3><p>有两个形参列表不同的重载方法：</p>
<ol>
<li><code>(ServiceRecord, int, int, int)</code>: 根据情况设置 ServiceRecord 和 StartItem 的一些信息；</li>
<li><code>(ServiceRecord, boolean, boolean)</code>: 负责在停止服务后清除剩余的记录。</li>
</ol>
<p>TODO</p>
<h2 id="Service-绑定流程"><a href="#Service-绑定流程" class="headerlink" title="Service 绑定流程"></a>Service 绑定流程</h2><p><img src="/images/2020-02-24-Service-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/bindService.svg" alt="Service 绑定流程"></p>
<p>应用组件绑定服务从 <code>bindService</code> 方法开始，这个方法调用 <code>bindServiceCommon</code> 。</p>
<h3 id="bindServiceCommon"><a href="#bindServiceCommon" class="headerlink" title="bindServiceCommon"></a><code>bindServiceCommon</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">bindServiceCommon</span><span class="params">(Intent service, ServiceConnection conn, <span class="type">int</span> flags,</span></span><br><span class="line"><span class="params">        String instanceName, Handler handler, Executor executor, UserHandle user)</span> &#123;</span><br><span class="line">    <span class="comment">// Keep this in sync with DevicePolicyManager.bindDeviceAdminServiceAsUser.</span></span><br><span class="line">    IServiceConnection sd;</span><br><span class="line">    <span class="keyword">if</span> (conn == <span class="literal">null</span>) &#123;...&#125;</span><br><span class="line">    <span class="keyword">if</span> (handler != <span class="literal">null</span> &amp;&amp; executor != <span class="literal">null</span>) &#123;...&#125;</span><br><span class="line">    <span class="keyword">if</span> (mPackageInfo != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (executor != <span class="literal">null</span>) &#123;</span><br><span class="line">            sd = mPackageInfo.getServiceDispatcher(conn, getOuterContext(), executor, flags);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            sd = mPackageInfo.getServiceDispatcher(conn, getOuterContext(), handler, flags);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;...&#125;</span><br><span class="line">    validateServiceIntent(service);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">IBinder</span> <span class="variable">token</span> <span class="operator">=</span> getActivityToken();</span><br><span class="line">        ...</span><br><span class="line">        service.prepareToLeaveProcess(<span class="built_in">this</span>);</span><br><span class="line">        <span class="type">int</span> <span class="variable">res</span> <span class="operator">=</span> ActivityManager.getService().bindIsolatedService(</span><br><span class="line">            mMainThread.getApplicationThread(), getActivityToken(), service,</span><br><span class="line">            service.resolveTypeIfNeeded(getContentResolver()),</span><br><span class="line">            sd, flags, instanceName, getOpPackageName(), user.getIdentifier());</span><br><span class="line">        <span class="keyword">if</span> (res &lt; <span class="number">0</span>) &#123;...&#125;</span><br><span class="line">        <span class="keyword">return</span> res != <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;...&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>调用 <code>LoadedApk.getServiceDispatcher</code> 获取实现了 IServiceConnection 接口的 Binder 对象，也就是 <code>ServiceDispatcher.InnerConnection</code>，这个方法进一步调用 <code>getServiceDispatcherCommon</code>；</li>
<li>调用 AMS 的 <code>bindIsolatedService</code> 方法，这个方法进一步调用 <code>ActiveServices.bindServiceLocked</code> 方法。</li>
</ol>
<h3 id="LoadedApk-getServiceDispatcher"><a href="#LoadedApk-getServiceDispatcher" class="headerlink" title="LoadedApk.getServiceDispatcher"></a><code>LoadedApk.getServiceDispatcher</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> IServiceConnection <span class="title function_">getServiceDispatcherCommon</span><span class="params">(ServiceConnection c,</span></span><br><span class="line"><span class="params">        Context context, Handler handler, Executor executor, <span class="type">int</span> flags)</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mServices) &#123;</span><br><span class="line">        LoadedApk.<span class="type">ServiceDispatcher</span> <span class="variable">sd</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        ArrayMap&lt;ServiceConnection, LoadedApk.ServiceDispatcher&gt; map = mServices.get(context);</span><br><span class="line">        <span class="keyword">if</span> (map != <span class="literal">null</span>) &#123;</span><br><span class="line">            sd = map.get(c);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (sd == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (executor != <span class="literal">null</span>) &#123;</span><br><span class="line">                sd = <span class="keyword">new</span> <span class="title class_">ServiceDispatcher</span>(c, context, executor, flags);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                sd = <span class="keyword">new</span> <span class="title class_">ServiceDispatcher</span>(c, context, handler, flags);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (map == <span class="literal">null</span>) &#123;</span><br><span class="line">                map = <span class="keyword">new</span> <span class="title class_">ArrayMap</span>&lt;&gt;();</span><br><span class="line">                mServices.put(context, map);</span><br><span class="line">            &#125;</span><br><span class="line">            map.put(c, sd);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            sd.validate(context, handler, executor);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sd.getIServiceConnection();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>每个 Service 组件与 Activity 组件的绑定在 LoadedApk 类的 <code>mService</code> 都对应一个 ServiceDispatcher 对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ArrayMap&lt;Context, ArrayMap&lt;ServiceConnection, LoadedApk.ServiceDispatcher&gt;&gt; mServices</span><br><span class="line">        = <span class="keyword">new</span> <span class="title class_">ArrayMap</span>&lt;&gt;();</span><br></pre></td></tr></table></figure>

<ol>
<li>如果找到已有的 ServiceDispatcher，就返回其 InnerConnection；</li>
<li>如果没有，就新建一个，保存到 <code>mService</code> 中，返回其 InnerConnection；</li>
</ol>
<h3 id="bindServiceLocked"><a href="#bindServiceLocked" class="headerlink" title="bindServiceLocked"></a><code>bindServiceLocked</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">bindServiceLocked</span><span class="params">(IApplicationThread caller, IBinder token, Intent service,</span></span><br><span class="line"><span class="params">        String resolvedType, <span class="keyword">final</span> IServiceConnection connection, <span class="type">int</span> flags,</span></span><br><span class="line"><span class="params">        String instanceName, String callingPackage, <span class="keyword">final</span> <span class="type">int</span> userId)</span></span><br><span class="line">        <span class="keyword">throws</span> TransactionTooLargeException &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">ProcessRecord</span> <span class="variable">callerApp</span> <span class="operator">=</span> mAm.getRecordForAppLocked(caller);</span><br><span class="line">    <span class="keyword">if</span> (callerApp == <span class="literal">null</span>) &#123;<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SecurityException</span>(...);&#125;</span><br><span class="line"></span><br><span class="line">    ActivityServiceConnectionsHolder&lt;ConnectionRecord&gt; activity = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (token != <span class="literal">null</span>) &#123;</span><br><span class="line">        activity = mAm.mAtmInternal.getServiceConnectionsHolder(token);</span><br><span class="line">        <span class="keyword">if</span> (activity == <span class="literal">null</span>) &#123; <span class="keyword">return</span> <span class="number">0</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...... <span class="comment">// 权限检查</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">callerFg</span> <span class="operator">=</span> callerApp.setSchedGroup != ProcessList.SCHED_GROUP_BACKGROUND;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">isBindExternal</span> <span class="operator">=</span> (flags &amp; Context.BIND_EXTERNAL_SERVICE) != <span class="number">0</span>;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="type">ServiceLookupResult</span> <span class="variable">res</span> <span class="operator">=</span></span><br><span class="line">        retrieveServiceLocked(service, instanceName, resolvedType, callingPackage,</span><br><span class="line">                Binder.getCallingPid(), Binder.getCallingUid(), userId, <span class="literal">true</span>,</span><br><span class="line">                callerFg, isBindExternal, allowInstant);</span><br><span class="line">    <span class="keyword">if</span> (res == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (res.record == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">ServiceRecord</span> <span class="variable">s</span> <span class="operator">=</span> res.record;</span><br></pre></td></tr></table></figure>

<ol>
<li>获取调用者对应的 ProcessRecord 和 ActivityServiceConnectionsHolder&lt;ConnectionRecord&gt;；</li>
<li>检查调用者是否在前台（<code>callerFg</code>），是否绑定了外部服务（<code>isBindExternal</code>）；</li>
<li>获取对应的 ServiceLookupResult，取出其中的 ServiceRecord；</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">... <span class="comment">// 如有必要，显示申请权限对话框</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">long</span> <span class="variable">origId</span> <span class="operator">=</span> Binder.clearCallingIdentity();</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="type">AppBindRecord</span> <span class="variable">b</span> <span class="operator">=</span> s.retrieveAppBindingLocked(service, callerApp);</span><br><span class="line">    <span class="type">ConnectionRecord</span> <span class="variable">c</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionRecord</span>(b, activity,</span><br><span class="line">            connection, flags, clientLabel, clientIntent,</span><br><span class="line">            callerApp.uid, callerApp.processName, callingPackage);</span><br><span class="line"></span><br><span class="line">    <span class="type">IBinder</span> <span class="variable">binder</span> <span class="operator">=</span> connection.asBinder();</span><br><span class="line">    s.addConnection(binder, c);</span><br><span class="line">    b.connections.add(c);</span><br><span class="line">    <span class="keyword">if</span> (activity != <span class="literal">null</span>) &#123;</span><br><span class="line">        activity.addConnection(c);</span><br><span class="line">    &#125;</span><br><span class="line">    b.client.connections.add(c);</span><br><span class="line">    c.startAssociationIfNeeded();</span><br><span class="line">    ...</span><br><span class="line">    ArrayList&lt;ConnectionRecord&gt; clist = mServiceConnections.get(binder);</span><br><span class="line">    <span class="keyword">if</span> (clist == <span class="literal">null</span>) &#123;</span><br><span class="line">        clist = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        mServiceConnections.put(binder, clist);</span><br><span class="line">    &#125;</span><br><span class="line">    clist.add(c);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((flags&amp;Context.BIND_AUTO_CREATE) != <span class="number">0</span>) &#123;</span><br><span class="line">        s.lastActivity = SystemClock.uptimeMillis();</span><br><span class="line">        <span class="keyword">if</span> (bringUpServiceLocked(s, service.getFlags(), callerFg, <span class="literal">false</span>,</span><br><span class="line">                permissionsReviewRequired) != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>获取或初始化相关变量：<ol>
<li>调用 <code>ServiceRecord.retrieveAppBindingLocked</code> 方法获取 AppBindRecord；</li>
<li>新建 ConnectionRecord 存入连接相关信息；</li>
<li>从 IServiceConnection 获取对应的 IBinder 对象；</li>
</ol>
</li>
<li>记录连接：<ol>
<li>在 ServiceRecord 记录；</li>
<li>在 AppBindRecord 以及对应客户端的 ProcessRecord 中记录；</li>
<li>在 <code>mServiceConnections</code> 列表中记录；</li>
</ol>
</li>
<li>如果调用 <code>bindService</code> 方法时设置了 <code>BIND_AUTO_CREATE</code> 标志，表示如果绑定服务尚未运行，则进行创建，调用 <code>bringUpServiceLocked</code> 启动服务，如果启动失败（返回值不为 <code>null</code>），直接返回结束；</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> (s.app != <span class="literal">null</span>) &#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="comment">// This could have made the service more important.</span></span><br><span class="line">            mAm.updateLruProcessLocked(s.app,</span><br><span class="line">                    (callerApp.hasActivitiesOrRecentTasks() &amp;&amp; s.app.hasClientActivities())</span><br><span class="line">                            || (callerApp.getCurProcState() &lt;= ActivityManager.PROCESS_STATE_TOP</span><br><span class="line">                                    &amp;&amp; (flags &amp; Context.BIND_TREAT_LIKE_ACTIVITY) != <span class="number">0</span>),</span><br><span class="line">                    b.client);</span><br><span class="line">            mAm.updateOomAdjLocked(OomAdjuster.OOM_ADJ_REASON_BIND_SERVICE);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (s.app != <span class="literal">null</span> &amp;&amp; b.intent.received) &#123;</span><br><span class="line">            <span class="comment">// Service is already running, so we can immediately</span></span><br><span class="line">            <span class="comment">// publish the connection.</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                c.conn.connected(s.name, b.intent.binder, <span class="literal">false</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;...&#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If this is the first app connected back to this binding,</span></span><br><span class="line">            <span class="comment">// and the service had previously asked to be told when</span></span><br><span class="line">            <span class="comment">// rebound, then do so.</span></span><br><span class="line">            <span class="keyword">if</span> (b.intent.apps.size() == <span class="number">1</span> &amp;&amp; b.intent.doRebind) &#123;</span><br><span class="line">                requestServiceBindingLocked(s, b.intent, callerFg, <span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!b.intent.requested) &#123;</span><br><span class="line">            requestServiceBindingLocked(s, b.intent, callerFg, <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        getServiceMapLocked(s.userId).ensureNotStartingBackgroundLocked(s);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Binder.restoreCallingIdentity(origId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>更新 LruProcess 和进程 OomAdj；</li>
<li>如果服务已经在运行，调用 <code>ServiceDispatcher.InnerConnection.connected</code> 方法，最终调用 <code>ServiceDispatcher.doConnected</code> 方法。还记得我们在<code>bindService</code> 的<em>调用方</em>获取或新建了一个 ServiceDispatcher 对象，返回了其实现了 IServiceConnection 接口的成员。因此这个方法实现位于 <code>LoadedApk.ServiceDispatcher.InnerConnection</code>，实际上调用 <code>LoadedApk.ServiceDispatcher.doConnected</code> 方法。这个方法实际上是处理调用者在 ServiceConnection 中实现的回调，在这里是 <code>onServiceConnected</code> 回调；</li>
<li>否则，调用 <code>requestServiceBindingLocked</code> 方法，最后一个参数 <code>rebind</code> 表明是重新绑定还是首次绑定。</li>
</ol>
<h3 id="requestServiceBindingLocked"><a href="#requestServiceBindingLocked" class="headerlink" title="requestServiceBindingLocked"></a><code>requestServiceBindingLocked</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">requestServiceBindingLocked</span><span class="params">(ServiceRecord r, IntentBindRecord i,</span></span><br><span class="line"><span class="params">        <span class="type">boolean</span> execInFg, <span class="type">boolean</span> rebind)</span> <span class="keyword">throws</span> TransactionTooLargeException &#123;</span><br><span class="line">    <span class="keyword">if</span> (r.app == <span class="literal">null</span> || r.app.thread == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// If service is not currently running, can&#x27;t yet bind.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((!i.requested || rebind) &amp;&amp; i.apps.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            bumpServiceExecutingLocked(r, execInFg, <span class="string">&quot;bind&quot;</span>);</span><br><span class="line">            r.app.forceProcessStateUpTo(ActivityManager.PROCESS_STATE_SERVICE);</span><br><span class="line">            r.app.thread.scheduleBindService(r, i.intent.getIntent(), rebind,</span><br><span class="line">                    r.app.getReportedProcState());</span><br><span class="line">            <span class="keyword">if</span> (!rebind) &#123;</span><br><span class="line">                i.requested = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            i.hasBound = <span class="literal">true</span>;</span><br><span class="line">            i.doRebind = <span class="literal">false</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (TransactionTooLargeException e) &#123;</span><br><span class="line">            <span class="comment">// Keep the executeNesting count accurate.</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">inDestroying</span> <span class="operator">=</span> mDestroyingServices.contains(r);</span><br><span class="line">            serviceDoneExecutingLocked(r, inDestroying, inDestroying);</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123; <span class="comment">/* 同上 */</span> <span class="keyword">return</span> <span class="literal">false</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>如果服务所在进程还没有运行，直接返回；</li>
<li>检查是否已经为 IntentBindRecord 对象 <code>i</code> 对应的应用进程请求过 Binder 本地对象，如果还没有则 <code>i.quested = false</code>，参数 <code>rebind</code> 表示是否需要将 Service 组件重新绑定到 <code>IntentBindRecord</code> 对象 <code>i</code>；</li>
<li>如果满足条件判断，调用 <code>ApplicationThread.scheduleBindService</code> 方法进行绑定，该方法会调用 <code>ActivityThread.handleBindService</code> 方法；</li>
<li>如果出现异常，销毁服务。</li>
</ol>
<h3 id="ActivityThread-handleBindService"><a href="#ActivityThread-handleBindService" class="headerlink" title="ActivityThread.handleBindService"></a><code>ActivityThread.handleBindService</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleBindService</span><span class="params">(BindServiceData data)</span> &#123;</span><br><span class="line">    <span class="type">Service</span> <span class="variable">s</span> <span class="operator">=</span> mServices.get(data.token);</span><br><span class="line">    <span class="keyword">if</span> (s != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            data.intent.setExtrasClassLoader(s.getClassLoader());</span><br><span class="line">            data.intent.prepareToEnterProcess();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!data.rebind) &#123;</span><br><span class="line">                    <span class="type">IBinder</span> <span class="variable">binder</span> <span class="operator">=</span> s.onBind(data.intent);</span><br><span class="line">                    ActivityManager.getService().publishService(</span><br><span class="line">                            data.token, data.intent, binder);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    s.onRebind(data.intent);</span><br><span class="line">                    ActivityManager.getService().serviceDoneExecuting(</span><br><span class="line">                            data.token, SERVICE_DONE_EXECUTING_ANON, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;...&#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;...&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>如果是首次绑定，调用 <code>onBind</code> 方法，调用 <code>AMS.publishService</code> 发布服务，此方法调用 <code>ActiveServices.publishServiceLocked</code> 方法；</li>
<li>否则，调用 <code>onRebind</code> 方法，调用 <code>AMS.serviceDoneExecuting</code> 通知操作已完成。</li>
</ol>
<h3 id="publishServiceLocked"><a href="#publishServiceLocked" class="headerlink" title="publishServiceLocked"></a><code>publishServiceLocked</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">publishServiceLocked</span><span class="params">(ServiceRecord r, Intent intent, IBinder service)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">long</span> <span class="variable">origId</span> <span class="operator">=</span> Binder.clearCallingIdentity();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (r != <span class="literal">null</span>) &#123;</span><br><span class="line">            Intent.<span class="type">FilterComparison</span> <span class="variable">filter</span></span><br><span class="line">                    <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>.FilterComparison(intent);</span><br><span class="line">            <span class="type">IntentBindRecord</span> <span class="variable">b</span> <span class="operator">=</span> r.bindings.get(filter);</span><br><span class="line">            <span class="keyword">if</span> (b != <span class="literal">null</span> &amp;&amp; !b.received) &#123;</span><br><span class="line">                b.binder = service;</span><br><span class="line">                b.requested = <span class="literal">true</span>;</span><br><span class="line">                b.received = <span class="literal">true</span>;</span><br><span class="line">                ArrayMap&lt;IBinder, ArrayList&lt;ConnectionRecord&gt;&gt; connections = r.getConnections();</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">conni</span> <span class="operator">=</span> connections.size() - <span class="number">1</span>; conni &gt;= <span class="number">0</span>; conni--) &#123;</span><br><span class="line">                    ArrayList&lt;ConnectionRecord&gt; clist = connections.valueAt(conni);</span><br><span class="line">                    <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i&lt;clist.size(); i++) &#123;</span><br><span class="line">                        <span class="type">ConnectionRecord</span> <span class="variable">c</span> <span class="operator">=</span> clist.get(i);</span><br><span class="line">                        <span class="keyword">if</span> (!filter.equals(c.binding.intent.intent)) &#123; <span class="keyword">continue</span>; &#125;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            c.conn.connected(r.name, service, <span class="literal">false</span>);</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (Exception e) &#123;...&#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            serviceDoneExecutingLocked(r, mDestroyingServices.contains(r), <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Binder.restoreCallingIdentity(origId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>设置 IntentBindRecord，将 <code>binder</code> 赋值为 <code>Service.onBind</code> 返回的 Binder 对象，将 <code>requested</code> 设置为 <code>true</code>，表示已调用 <code>onBind</code>；</li>
<li>遍历 ServiceRecord 中的连接记录，调用其成员 <code>IServiceConnection conn</code> 的 <code>connected</code> 方法。</li>
<li>调用 <code>ServiceDoneExecutingLocked</code> 方法结束。</li>
</ol>
<h3 id="LoadedApk-ServiceDispatcher-connected"><a href="#LoadedApk-ServiceDispatcher-connected" class="headerlink" title="LoadedApk.ServiceDispatcher.connected"></a><code>LoadedApk.ServiceDispatcher.connected</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">connected</span><span class="params">(ComponentName name, IBinder service, <span class="type">boolean</span> dead)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (mActivityExecutor != <span class="literal">null</span>) &#123;</span><br><span class="line">        mActivityExecutor.execute(<span class="keyword">new</span> <span class="title class_">RunConnection</span>(name, service, <span class="number">0</span>, dead));</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mActivityThread != <span class="literal">null</span>) &#123;</span><br><span class="line">        mActivityThread.post(<span class="keyword">new</span> <span class="title class_">RunConnection</span>(name, service, <span class="number">0</span>, dead));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        doConnected(name, service, dead);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">RunConnection</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">    RunConnection(ComponentName name, IBinder service, <span class="type">int</span> command, <span class="type">boolean</span> dead) &#123;...&#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mCommand == <span class="number">0</span>) &#123;</span><br><span class="line">            doConnected(mName, mService, mDead);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mCommand == <span class="number">1</span>) &#123;</span><br><span class="line">            doDeath(mName, mService);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>如果 ServiceDispatcher 是用 Executor 初始化，调用 Executor 的 <code>execute</code> 方法执行 <code>RunConnection.run()</code> 方法，这一方法最终执行 <code>doConnected</code> 方法；</li>
<li>如果是用 ActivityThread 的 Handler 初始化，调用 Handler 的 <code>post</code> 方法执行该方法；</li>
<li>如果以上两种情况都不是，直接执行 <code>doConnected</code> 方法。</li>
</ol>
<h3 id="LoadedApk-ServiceDispatcher-doConnected"><a href="#LoadedApk-ServiceDispatcher-doConnected" class="headerlink" title="LoadedApk.ServiceDispatcher.doConnected"></a><code>LoadedApk.ServiceDispatcher.doConnected</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doConnected</span><span class="params">(ComponentName name, IBinder service, <span class="type">boolean</span> dead)</span> &#123;</span><br><span class="line">    ServiceDispatcher.ConnectionInfo old;</span><br><span class="line">    ServiceDispatcher.ConnectionInfo info;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mForgotten) &#123;</span><br><span class="line">            <span class="comment">// We unbound before receiving the connection; ignore</span></span><br><span class="line">            <span class="comment">// any connection received.</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        old = mActiveConnections.get(name);</span><br><span class="line">        <span class="keyword">if</span> (old != <span class="literal">null</span> &amp;&amp; old.binder == service) &#123;</span><br><span class="line">            <span class="comment">// Huh, already have this one.  Oh well!</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>如果收到连接请求前已经 unbind，就不作处理直接返回；</li>
<li>从 <code>mActiveConnections</code> 获取组件目前活跃的连接。如果这个组件已经持有当前服务的连接，直接返回；</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (service != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// A new service is being connected... set it all up.</span></span><br><span class="line">        info = <span class="keyword">new</span> <span class="title class_">ConnectionInfo</span>();</span><br><span class="line">        info.binder = service;</span><br><span class="line">        info.deathMonitor = <span class="keyword">new</span> <span class="title class_">DeathMonitor</span>(name, service);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            service.linkToDeath(info.deathMonitor, <span class="number">0</span>);</span><br><span class="line">            mActiveConnections.put(name, info);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            <span class="comment">// This service was dead before we got it...  just</span></span><br><span class="line">            <span class="comment">// don&#x27;t do anything with it.</span></span><br><span class="line">            mActiveConnections.remove(name);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// The named service is being disconnected... clean up.</span></span><br><span class="line">        mActiveConnections.remove(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (old != <span class="literal">null</span>) &#123;</span><br><span class="line">        old.binder.unlinkToDeath(old.deathMonitor, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>处理新连接:<ol>
<li>创建新 ConnectionInfo，存入要连接的服务和死亡回调信息；</li>
<li>服务调用 <code>linkToDeath</code> 注册死亡回调；</li>
<li>将新的 ConnectionInfo 存入 <code>mActiveConnections</code>；</li>
<li>如果发生异常，远程对象已死，则移除之前添加的 ConnectionInfo；</li>
<li>如果之前持有旧连接，注销旧连接的服务的死亡回调；</li>
</ol>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">// If there was an old service, it is now disconnected.</span></span><br><span class="line">    <span class="keyword">if</span> (old != <span class="literal">null</span>) &#123;</span><br><span class="line">        mConnection.onServiceDisconnected(name);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (dead) &#123;</span><br><span class="line">        mConnection.onBindingDied(name);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// If there is a new viable service, it is now connected.</span></span><br><span class="line">    <span class="keyword">if</span> (service != <span class="literal">null</span>) &#123;</span><br><span class="line">        mConnection.onServiceConnected(name, service);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// The binding machinery worked, but the remote returned null from onBind().</span></span><br><span class="line">        mConnection.onNullBinding(name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>处理 ServiceConnection 回调：<ol>
<li>如果组件之前绑定其他服务，调用 <code>onServiceDisconnected</code> 回调；</li>
<li>如果是 <code>bringDownService</code> 方法调用的，<code>dead = true</code>，调用 <code>onBindingDied</code> 回调；</li>
<li>如果有新服务连接上，调用 <code>onServiceConnected</code> 回调；</li>
<li>否则，调用 <code>onNullBinding</code> 回调。</li>
</ol>
</li>
</ol>
<h2 id="Service-解绑流程"><a href="#Service-解绑流程" class="headerlink" title="Service 解绑流程"></a>Service 解绑流程</h2><p><img src="/images/2020-02-24-Service-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/unbindService.svg" alt="Service 解绑流程"></p>
<p>应用组件调用 <code>Context.unbindService</code> 方法解除与 Service 的绑定。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unbindService</span><span class="params">(ServiceConnection conn)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (conn == <span class="literal">null</span>) &#123;...&#125;</span><br><span class="line">    <span class="keyword">if</span> (mPackageInfo != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">IServiceConnection</span> <span class="variable">sd</span> <span class="operator">=</span> mPackageInfo.forgetServiceDispatcher(</span><br><span class="line">                getOuterContext(), conn);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ActivityManager.getService().unbindService(sd);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;...&#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;...&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>AMS.unbindService</code> 调用 <code>ActiveServices.unbindServiceLocked</code> 方法。</p>
<h3 id="ActiveServices-unbindServiceLocked"><a href="#ActiveServices-unbindServiceLocked" class="headerlink" title="ActiveServices.unbindServiceLocked"></a><code>ActiveServices.unbindServiceLocked</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">boolean</span> <span class="title function_">unbindServiceLocked</span><span class="params">(IServiceConnection connection)</span> &#123;</span><br><span class="line">    <span class="type">IBinder</span> <span class="variable">binder</span> <span class="operator">=</span> connection.asBinder();</span><br><span class="line">    ArrayList&lt;ConnectionRecord&gt; clist = mServiceConnections.get(binder);</span><br><span class="line">    <span class="keyword">if</span> (clist == <span class="literal">null</span>) &#123; <span class="keyword">return</span> <span class="literal">false</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">long</span> <span class="variable">origId</span> <span class="operator">=</span> Binder.clearCallingIdentity();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (clist.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="type">ConnectionRecord</span> <span class="variable">r</span> <span class="operator">=</span> clist.get(<span class="number">0</span>);</span><br><span class="line">            removeConnectionLocked(r, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">            <span class="keyword">if</span> (clist.size() &gt; <span class="number">0</span> &amp;&amp; clist.get(<span class="number">0</span>) == r) &#123;</span><br><span class="line">                clist.remove(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            ... <span class="comment">// 调整 LruProcess</span></span><br><span class="line">        &#125;</span><br><span class="line">        mAm.updateOomAdjLocked(OomAdjuster.OOM_ADJ_REASON_UNBIND_SERVICE);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Binder.restoreCallingIdentity(origId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>主要工作是从 <code>mServiceConnections</code> 中找到对应的连接记录列表，对列表中的每一个连接调用 <code>removeConnectionLocked</code> 方法。</p>
<h3 id="ActiveServices-removeConnectionLocked"><a href="#ActiveServices-removeConnectionLocked" class="headerlink" title="ActiveServices.removeConnectionLocked"></a><code>ActiveServices.removeConnectionLocked</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">removeConnectionLocked</span><span class="params">(ConnectionRecord c, ProcessRecord skipApp,</span></span><br><span class="line"><span class="params">        ActivityServiceConnectionsHolder skipAct)</span> &#123;</span><br><span class="line">    <span class="type">IBinder</span> <span class="variable">binder</span> <span class="operator">=</span> c.conn.asBinder();</span><br><span class="line">    <span class="type">AppBindRecord</span> <span class="variable">b</span> <span class="operator">=</span> c.binding;</span><br><span class="line">    <span class="type">ServiceRecord</span> <span class="variable">s</span> <span class="operator">=</span> b.service;</span><br><span class="line">    ArrayList&lt;ConnectionRecord&gt; clist = s.getConnections().get(binder);</span><br><span class="line">    <span class="keyword">if</span> (clist != <span class="literal">null</span>) &#123;</span><br><span class="line">        clist.remove(c);</span><br><span class="line">        <span class="keyword">if</span> (clist.size() == <span class="number">0</span>) &#123;</span><br><span class="line">            s.removeConnection(binder);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    b.connections.remove(c);</span><br><span class="line">    c.stopAssociation();</span><br><span class="line">    <span class="keyword">if</span> (c.activity != <span class="literal">null</span> &amp;&amp; c.activity != skipAct) &#123;</span><br><span class="line">        c.activity.removeConnection(c);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (b.client != skipApp) &#123;</span><br><span class="line">        b.client.connections.remove(c);</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">    clist = mServiceConnections.get(binder);</span><br><span class="line">    <span class="keyword">if</span> (clist != <span class="literal">null</span>) &#123;</span><br><span class="line">        clist.remove(c);</span><br><span class="line">        <span class="keyword">if</span> (clist.size() == <span class="number">0</span>) &#123;</span><br><span class="line">            mServiceConnections.remove(binder);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mAm.stopAssociationLocked(b.client.uid, b.client.processName, s.appInfo.uid,</span><br><span class="line">            s.appInfo.longVersionCode, s.instanceName, s.processName);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (b.connections.size() == <span class="number">0</span>) &#123;</span><br><span class="line">        b.intent.apps.remove(b.client);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!c.serviceDead) &#123;</span><br><span class="line">        <span class="keyword">if</span> (s.app != <span class="literal">null</span> &amp;&amp; s.app.thread != <span class="literal">null</span> &amp;&amp; b.intent.apps.size() == <span class="number">0</span></span><br><span class="line">                &amp;&amp; b.intent.hasBound) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                bumpServiceExecutingLocked(s, <span class="literal">false</span>, <span class="string">&quot;unbind&quot;</span>);</span><br><span class="line">                ... <span class="comment">// 调整 LruProcess 和 OomAdj，又来一遍？</span></span><br><span class="line">                b.intent.hasBound = <span class="literal">false</span>;</span><br><span class="line">                <span class="comment">// Assume the client doesn&#x27;t want to know about a rebind;</span></span><br><span class="line">                <span class="comment">// we will deal with that later if it asks for one.</span></span><br><span class="line">                b.intent.doRebind = <span class="literal">false</span>;</span><br><span class="line">                s.app.thread.scheduleUnbindService(s, b.intent.intent.getIntent());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                serviceProcessGoneLocked(s);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If unbound while waiting to start, remove the pending service</span></span><br><span class="line">        mPendingServices.remove(s);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((c.flags&amp;Context.BIND_AUTO_CREATE) != <span class="number">0</span>) &#123;</span><br><span class="line">            ......</span><br><span class="line">            bringDownServiceIfNeededLocked(s, <span class="literal">true</span>, hasAutoCreate);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>移除连接记录 ConnectionRecord：<ol>
<li>获取 ServiceRecord 中的连接列表，从该列表中移除；</li>
<li>从 AppBindRecord 中移除连接记录；</li>
<li>从 <code>mServiceConnections</code> 中移除连接记录；</li>
<li>如果 AppBindRecord 中记录为空了，从 <code>b.intent.apps</code> 中移除客户端；</li>
</ol>
</li>
<li>如果服务还存在，调用 <code>ApplicationThread.scheduleUnbindServie</code>，该方法通过 Handler 调用 <code>ActivityThread.handleUnbindService</code> 方法；</li>
<li>从 <code>mPendingServices</code> 中移除 ServiceRecord；</li>
<li>调用 <code>bringDownServiceIfNeededLocked</code> 方法，如果服务不再被需要，就关闭服务。</li>
</ol>
<h3 id="ActivityThread-handleUnbindService"><a href="#ActivityThread-handleUnbindService" class="headerlink" title="ActivityThread.handleUnbindService"></a><code>ActivityThread.handleUnbindService</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleUnbindService</span><span class="params">(BindServiceData data)</span> &#123;</span><br><span class="line">    <span class="type">Service</span> <span class="variable">s</span> <span class="operator">=</span> mServices.get(data.token);</span><br><span class="line">    <span class="keyword">if</span> (s != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            data.intent.setExtrasClassLoader(s.getClassLoader());</span><br><span class="line">            data.intent.prepareToEnterProcess();</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">doRebind</span> <span class="operator">=</span> s.onUnbind(data.intent);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (doRebind) &#123;</span><br><span class="line">                    ActivityManager.getService().unbindFinished(</span><br><span class="line">                            data.token, data.intent, doRebind);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    ActivityManager.getService().serviceDoneExecuting(</span><br><span class="line">                            data.token, SERVICE_DONE_EXECUTING_ANON, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;...&#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;...&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>调用 <code>Service.onUnbind</code> 方法，返回值表示是否需要在新的客户端绑定到该服务时调用 <code>onRebind</code> 方法；</li>
<li>如果需要，调用 <code>AMS.unbindFinished</code> 方法，进一步调用 <code>ActiveServices.unbindFinishedLocked</code> 方法；</li>
<li>否则，调用 <code>AMS.serviceDoneExecuting</code> 方法；</li>
</ol>
<h3 id="ActiveServices-unbindFinishedLocked"><a href="#ActiveServices-unbindFinishedLocked" class="headerlink" title="ActiveServices.unbindFinishedLocked"></a><code>ActiveServices.unbindFinishedLocked</code></h3><p>这个方法没有用到 <code>doRebind</code> 参数，因为 ActivityThread 只会在 <code>doRebind = true</code> 时调用这个方法，因此这个方法实际上做的事情总是要求服务调用 <code>onRebind</code> 方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">unbindFinishedLocked</span><span class="params">(ServiceRecord r, Intent intent, <span class="type">boolean</span> doRebind)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">long</span> <span class="variable">origId</span> <span class="operator">=</span> Binder.clearCallingIdentity();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (r != <span class="literal">null</span>) &#123;</span><br><span class="line">            Intent.<span class="type">FilterComparison</span> <span class="variable">filter</span></span><br><span class="line">                    <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>.FilterComparison(intent);</span><br><span class="line">            <span class="type">IntentBindRecord</span> <span class="variable">b</span> <span class="operator">=</span> r.bindings.get(filter);</span><br><span class="line"></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">inDestroying</span> <span class="operator">=</span> mDestroyingServices.contains(r);</span><br><span class="line">            <span class="keyword">if</span> (b != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (b.apps.size() &gt; <span class="number">0</span> &amp;&amp; !inDestroying) &#123;</span><br><span class="line">                    <span class="comment">// Applications have already bound since the last</span></span><br><span class="line">                    <span class="comment">// unbind, so just rebind right here.</span></span><br><span class="line">                    <span class="type">boolean</span> <span class="variable">inFg</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="type">int</span> i=b.apps.size()-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</span><br><span class="line">                        <span class="type">ProcessRecord</span> <span class="variable">client</span> <span class="operator">=</span> b.apps.valueAt(i).client;</span><br><span class="line">                        <span class="keyword">if</span> (client != <span class="literal">null</span> &amp;&amp; client.setSchedGroup</span><br><span class="line">                                != ProcessList.SCHED_GROUP_BACKGROUND) &#123;</span><br><span class="line">                            inFg = <span class="literal">true</span>;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        requestServiceBindingLocked(r, b, inFg, <span class="literal">true</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (TransactionTooLargeException e) &#123;</span><br><span class="line">                        <span class="comment">// Don&#x27;t pass this back to ActivityThread, it&#x27;s unrelated.</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// Note to tell the service the next time there is</span></span><br><span class="line">                    <span class="comment">// a new client.</span></span><br><span class="line">                    b.doRebind = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            serviceDoneExecutingLocked(r, inDestroying, <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Binder.restoreCallingIdentity(origId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>从 ServiceRecord 中获取相应的 IntentBindRecord，获取绑定和应用的当前状态；</li>
<li>如果应用在上次解绑之后已经重新绑定，就直接调用 <code>requestServiceBindingLocked</code> 方法，最后一个参数 <code>rebind = true</code>；</li>
<li>否则，令 IntentBindRecord 的 <code>doRebind = true</code>，以通知服务有新的客户端时调用 <code>onRebind</code> 方法；</li>
</ol>
<h3 id="AMS-stopAssociationLocked"><a href="#AMS-stopAssociationLocked" class="headerlink" title="AMS.stopAssociationLocked"></a><code>AMS.stopAssociationLocked</code></h3><p>TODO</p>
<h2 id="Service-停止流程"><a href="#Service-停止流程" class="headerlink" title="Service 停止流程"></a>Service 停止流程</h2><h3 id="服务停止的方式"><a href="#服务停止的方式" class="headerlink" title="服务停止的方式"></a>服务停止的方式</h3><p>应用组件可以通过两种方式停止服务：</p>
<ol>
<li><code>stopService</code></li>
<li><code>unbindService</code></li>
</ol>
<p>此外，服务自身可以调用 <code>stopSelf</code> 停止自身。</p>
<p>这三种方式最终都会调用 <code>bringDownServiceIfNeededLocked</code> 方法。然而这种方法并不保证停止服务：服务启动完成，并且没有自动创建服务的连接（见 <a href="#servicerecordhasautocreateconnection"><code>hasAutoCreateConnection</code></a>）时，才会调用 <code>bringDownServiceLocked</code> 真正停止服务。</p>
<h4 id="调用-stopService-停止服务"><a href="#调用-stopService-停止服务" class="headerlink" title="调用 stopService 停止服务"></a>调用 <code>stopService</code> 停止服务</h4><p><code>stopService -&gt; ContextImpl.stopServiceCommon -&gt; AMS.stopService -&gt; ActiveServices.stopServiceLocked(IApplicationThread, Intent, String, int) -&gt; stopServiceLocked(ServiceRecord) -&gt; bringDownServiceIfNeededLocked</code></p>
<p><img src="/images/2020-02-24-Service-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/stopService.svg" alt="Service 停止流程"></p>
<h4 id="调用-unbindService-解绑最后一个客户端"><a href="#调用-unbindService-解绑最后一个客户端" class="headerlink" title="调用 unbindService 解绑最后一个客户端"></a>调用 <code>unbindService</code> 解绑最后一个客户端</h4><p><code>unbindService -&gt; unbindServiceLocked -&gt; bringDownServiceIfNeededLocked</code></p>
<h4 id="服务调用-stopSelf-停止"><a href="#服务调用-stopSelf-停止" class="headerlink" title="服务调用 stopSelf 停止"></a>服务调用 <code>stopSelf</code> 停止</h4><p><code>stopSelf -&gt; AMS.stopServiceToken -&gt; ActiveServices.stopServiceTokenLocked -&gt; bringDownServiceIfNeededLocked</code></p>
<h3 id="bringDownServiceIfNeededLocked"><a href="#bringDownServiceIfNeededLocked" class="headerlink" title="bringDownServiceIfNeededLocked"></a><code>bringDownServiceIfNeededLocked</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">bringDownServiceIfNeededLocked</span><span class="params">(ServiceRecord r, <span class="type">boolean</span> knowConn,</span></span><br><span class="line"><span class="params">        <span class="type">boolean</span> hasConn)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (isServiceNeededLocked(r, knowConn, hasConn)) &#123; <span class="keyword">return</span>; &#125;</span><br><span class="line">    <span class="keyword">if</span> (mPendingServices.contains(r)) &#123; <span class="keyword">return</span>; &#125;</span><br><span class="line">    bringDownServiceLocked(r);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="isServiceNeededLocked"><a href="#isServiceNeededLocked" class="headerlink" title="isServiceNeededLocked"></a><code>isServiceNeededLocked</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">isServiceNeededLocked</span><span class="params">(ServiceRecord r, <span class="type">boolean</span> knowConn,</span></span><br><span class="line"><span class="params">        <span class="type">boolean</span> hasConn)</span> &#123;</span><br><span class="line">    <span class="comment">// Are we still explicitly being asked to run?</span></span><br><span class="line">    <span class="keyword">if</span> (r.startRequested) &#123; <span class="keyword">return</span> <span class="literal">true</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Is someone still bound to us keeping us running?</span></span><br><span class="line">    <span class="keyword">if</span> (!knowConn) &#123;</span><br><span class="line">        hasConn = r.hasAutoCreateConnections();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (hasConn) &#123; <span class="keyword">return</span> <span class="literal">true</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用 <code>stopServiceLocked(ServiceRecord)</code> 方法时会将 <code>startRequested</code> 标志设为 <code>false</code>，因此<strong>调用 <code>stopService</code> 时</strong>实际检查的只有是否还有活跃的绑定。</p>
<h3 id="ServiceRecord-hasAutoCreateConnection"><a href="#ServiceRecord-hasAutoCreateConnection" class="headerlink" title="ServiceRecord.hasAutoCreateConnection"></a><code>ServiceRecord.hasAutoCreateConnection</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hasAutoCreateConnections</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// XXX should probably keep a count of the number of auto-create</span></span><br><span class="line">    <span class="comment">// connections directly in the service.</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> conni=connections.size()-<span class="number">1</span>; conni&gt;=<span class="number">0</span>; conni--) &#123;</span><br><span class="line">        ArrayList&lt;ConnectionRecord&gt; cr = connections.valueAt(conni);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i&lt;cr.size(); i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((cr.get(i).flags&amp;Context.BIND_AUTO_CREATE) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>遍历保存的连接列表，当有在 <code>bindService</code> 时设置了 <code>BIND_AUTO_CREATE</code> 标志的活跃连接，就返回 <code>true</code>。因此只有所有设置了 <code>BIND_AUTO_CREATE</code> 标志的客户端调用了 <code>unbindService</code> 时，服务才会停止。</p>
<h3 id="bringDownServiceLocked"><a href="#bringDownServiceLocked" class="headerlink" title="bringDownServiceLocked"></a><code>bringDownServiceLocked</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">bringDownServiceLocked</span><span class="params">(ServiceRecord r)</span> &#123;</span><br><span class="line">    ArrayMap&lt;IBinder, ArrayList&lt;ConnectionRecord&gt;&gt; connections = r.getConnections();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">conni</span> <span class="operator">=</span> connections.size() - <span class="number">1</span>; conni &gt;= <span class="number">0</span>; conni--) &#123;</span><br><span class="line">        ArrayList&lt;ConnectionRecord&gt; c = connections.valueAt(conni);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i&lt;c.size(); i++) &#123;</span><br><span class="line">            <span class="type">ConnectionRecord</span> <span class="variable">cr</span> <span class="operator">=</span> c.get(i);</span><br><span class="line">            <span class="comment">// There is still a connection to the service that is</span></span><br><span class="line">            <span class="comment">// being brought down.  Mark it as dead.</span></span><br><span class="line">            cr.serviceDead = <span class="literal">true</span>;</span><br><span class="line">            cr.stopAssociation();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                cr.conn.connected(r.name, <span class="literal">null</span>, <span class="literal">true</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;...&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>对所有活跃绑定，调用 <code>ServiceDispatcher.InnerDispatcher.connected</code> 以发送 <code>onBindingDied</code> 回调；</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Tell the service that it has been unbound.</span></span><br><span class="line"><span class="keyword">if</span> (r.app != <span class="literal">null</span> &amp;&amp; r.app.thread != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">needOomAdj</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> r.bindings.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        <span class="type">IntentBindRecord</span> <span class="variable">ibr</span> <span class="operator">=</span> r.bindings.valueAt(i);</span><br><span class="line">        <span class="keyword">if</span> (ibr.hasBound) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                bumpServiceExecutingLocked(r, <span class="literal">false</span>, <span class="string">&quot;bring down unbind&quot;</span>);</span><br><span class="line">                needOomAdj = <span class="literal">true</span>;</span><br><span class="line">                ibr.hasBound = <span class="literal">false</span>;</span><br><span class="line">                ibr.requested = <span class="literal">false</span>;</span><br><span class="line">                r.app.thread.scheduleUnbindService(r,</span><br><span class="line">                        ibr.intent.getIntent());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123; serviceProcessGoneLocked(r); &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (needOomAdj) &#123;</span><br><span class="line">        mAm.updateOomAdjLocked(r.app, <span class="literal">true</span>,</span><br><span class="line">                OomAdjuster.OOM_ADJ_REASON_UNBIND_SERVICE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>如果有活跃绑定，更新 IntentBindRecord 状态，调用 <code>ApplicationThread.scheduleUnbindService</code> 安排解绑，调整 OomAdj；</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Check to see if the service had been started as foreground, but being</span></span><br><span class="line"><span class="comment">// brought down before actually showing a notification.  That is not allowed.</span></span><br><span class="line"><span class="keyword">if</span> (r.fgRequired) &#123;</span><br><span class="line">    r.fgRequired = <span class="literal">false</span>;</span><br><span class="line">    r.fgWaiting = <span class="literal">false</span>;</span><br><span class="line">    ...</span><br><span class="line">    mAm.mAppOpsService.finishOperation(AppOpsManager.getToken(mAm.mAppOpsService),</span><br><span class="line">            AppOpsManager.OP_START_FOREGROUND, r.appInfo.uid, r.packageName);</span><br><span class="line">    mAm.mHandler.removeMessages(</span><br><span class="line">            ActivityManagerService.SERVICE_FOREGROUND_TIMEOUT_MSG, r);</span><br><span class="line">    <span class="keyword">if</span> (r.app != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> mAm.mHandler.obtainMessage(</span><br><span class="line">                ActivityManagerService.SERVICE_FOREGROUND_CRASH_MSG);</span><br><span class="line">        msg.obj = r.app;</span><br><span class="line">        msg.getData().putCharSequence(</span><br><span class="line">            ActivityManagerService.SERVICE_RECORD_KEY, r.toString());</span><br><span class="line">        mAm.mHandler.sendMessage(msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>TODO</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">ServiceMap</span> <span class="variable">smap</span> <span class="operator">=</span> getServiceMapLocked(r.userId);</span><br><span class="line"><span class="type">ServiceRecord</span> <span class="variable">found</span> <span class="operator">=</span> smap.mServicesByInstanceName.remove(r.instanceName);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Note when this method is called by bringUpServiceLocked(), the service is not found</span></span><br><span class="line"><span class="comment">// in mServicesByInstanceName and found will be null.</span></span><br><span class="line"><span class="keyword">if</span> (found != <span class="literal">null</span> &amp;&amp; found != r) &#123; <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(...); &#125;</span><br><span class="line">smap.mServicesByIntent.remove(r.intent);</span><br><span class="line">r.totalRestartCount = <span class="number">0</span>;</span><br><span class="line">unscheduleServiceRestartLocked(r, <span class="number">0</span>, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Also make sure it is not on the pending list.</span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i=mPendingServices.size()-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</span><br><span class="line">    <span class="keyword">if</span> (mPendingServices.get(i) == r) &#123;</span><br><span class="line">        mPendingServices.remove(i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">cancelForegroundNotificationLocked(r);</span><br><span class="line"><span class="keyword">if</span> (r.isForeground) &#123;</span><br><span class="line">    decActiveForegroundAppLocked(smap, r);</span><br><span class="line">    ...</span><br><span class="line">    mAm.mAppOpsService.finishOperation(</span><br><span class="line">            AppOpsManager.getToken(mAm.mAppOpsService),</span><br><span class="line">            AppOpsManager.OP_START_FOREGROUND, r.appInfo.uid, r.packageName);</span><br><span class="line">    mAm.updateForegroundServiceUsageStats(r.name, r.userId, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">r.isForeground = <span class="literal">false</span>;</span><br><span class="line">r.foregroundId = <span class="number">0</span>;</span><br><span class="line">r.foregroundNoti = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Clear start entries.</span></span><br><span class="line">r.clearDeliveredStartsLocked();</span><br><span class="line">r.pendingStarts.clear();</span><br><span class="line">smap.mDelayedStartList.remove(r);</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>从 ServiceMap 中移除服务记录；</li>
<li>调用 <code>unscheduleServiceRestartLocked</code> 取消重启服务的安排；</li>
<li>从 <code>mPendingServices</code> 中移除记录；</li>
<li>如果是前台服务，取消前台通知；</li>
<li>清除在 <code>ServiceRecord.pendingStarts</code> 队列中的参数；</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r.app != <span class="literal">null</span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">        r.app.services.remove(r);</span><br><span class="line">        r.app.updateBoundClientUids();</span><br><span class="line">        <span class="keyword">if</span> (r.whitelistManager) &#123;</span><br><span class="line">            updateWhitelistManagerLocked(r.app);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (r.app.thread != <span class="literal">null</span>) &#123;</span><br><span class="line">            updateServiceForegroundLocked(r.app, <span class="literal">false</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                bumpServiceExecutingLocked(r, <span class="literal">false</span>, <span class="string">&quot;destroy&quot;</span>);</span><br><span class="line">                mDestroyingServices.add(r);</span><br><span class="line">                r.destroying = <span class="literal">true</span>;</span><br><span class="line">                mAm.updateOomAdjLocked(r.app, <span class="literal">true</span>,</span><br><span class="line">                        OomAdjuster.OOM_ADJ_REASON_UNBIND_SERVICE);</span><br><span class="line">                r.app.thread.scheduleStopService(r);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123; serviceProcessGoneLocked(r); &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;...&#125; <span class="keyword">else</span> &#123;...&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r.bindings.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        r.bindings.clear();</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="8">
<li>移除 ProcessRecord 中的记录；</li>
<li>加入 <code>mDestroyingServices</code> 列表；</li>
<li>调用 <code>ApplicationThread.scheduleStopService</code> 停止服务，跟之前类似，这个方法调用 <code>ActivityThread.handleStopService</code> 方法；</li>
</ol>
<h3 id="ActivityThread-handleStopService"><a href="#ActivityThread-handleStopService" class="headerlink" title="ActivityThread.handleStopService"></a><code>ActivityThread.handleStopService</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleStopService</span><span class="params">(IBinder token)</span> &#123;</span><br><span class="line">    <span class="type">Service</span> <span class="variable">s</span> <span class="operator">=</span> mServices.remove(token);</span><br><span class="line">    <span class="keyword">if</span> (s != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            s.onDestroy();</span><br><span class="line">            s.detachAndCleanUp();</span><br><span class="line">            <span class="type">Context</span> <span class="variable">context</span> <span class="operator">=</span> s.getBaseContext();</span><br><span class="line">            <span class="keyword">if</span> (context <span class="keyword">instanceof</span> ContextImpl) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">String</span> <span class="variable">who</span> <span class="operator">=</span> s.getClassName();</span><br><span class="line">                ((ContextImpl) context).scheduleFinalCleanup(who, <span class="string">&quot;Service&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            QueuedWork.waitToFinish();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                ActivityManager.getService().serviceDoneExecuting(</span><br><span class="line">                        token, SERVICE_DONE_EXECUTING_STOP, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;...&#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;...&#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;...&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>移除服务在 <code>mServices</code> 中的引用；</li>
<li>调用 <code>Service.onDestroy</code> 回调；</li>
<li>调用 <code>Service.detachAndCleanUp</code> ，令 <code>mToken = null</code> 以移除其引用；</li>
<li>调用 <code>ContextImpl.scheduleFinalCleanup</code>，最终调用 <code>LoadedApk.removeContextRegistration</code>，清除其对应 Context 注册的 BroadcastReceiver。</li>
<li>调用 <code>AMS.serviceDoneExecuting</code> 回调，清除剩余的服务记录。</li>
</ol>
<h2 id="Service-被杀重新启动的流程"><a href="#Service-被杀重新启动的流程" class="headerlink" title="Service 被杀重新启动的流程"></a>Service 被杀重新启动的流程</h2><p><img src="/images/2020-02-24-Service-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/restartService.svg" alt="Service 重启流程"></p>
<h3 id="应用被杀的回调"><a href="#应用被杀的回调" class="headerlink" title="应用被杀的回调"></a>应用被杀的回调</h3><p>在 ContentProvider 源码分析中提到过，在 <code>AMS.attachApplicationLocked</code> 方法中，添加了 ActivityThread 对象的死亡回调，调用了 <code>appDiedLocked</code> 方法，这样 AMS 就可以在进程死亡时完成善后工作。</p>
<p>对于 Service 被杀后重新启动这一过程，相关的调用过程为：<br><code>appDiedLocked -&gt; handleAppDiedLocked -&gt; cleanUpApplicationRecordLocked -&gt; ActiveServices.killServicesLocked</code></p>
<h4 id="killServicesLocked"><a href="#killServicesLocked" class="headerlink" title="killServicesLocked"></a><code>killServicesLocked</code></h4><ol>
<li>遍历 ProcessRecord 中的 <code>services</code> 列表，判断其中的服务是否需要重启，如果需要则调用 <code>scheduleServiceRestartLocked</code> 安排启动服务，否则调用 <code>bringDownServiceLocked</code> 将其清理干净；</li>
<li>如果设置传入形参 <code>allowRestart = false</code>，从 ProcessRecord，<code>mRestartingServices</code>，<code>mPendingServices</code> 中清除相应记录；</li>
<li>从 <code>mDestroyingServices</code> 清除这个进程待销毁的服务记录；</li>
</ol>
<h3 id="AMS-发起重启服务"><a href="#AMS-发起重启服务" class="headerlink" title="AMS 发起重启服务"></a>AMS 发起重启服务</h3><h4 id="scheduleServiceRestartLocked"><a href="#scheduleServiceRestartLocked" class="headerlink" title="scheduleServiceRestartLocked"></a><code>scheduleServiceRestartLocked</code></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">scheduleServiceRestartLocked</span><span class="params">(ServiceRecord r, <span class="type">boolean</span> allowCancel)</span> &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">canceled</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mAm.mAtmInternal.isShuttingDown()) &#123; <span class="keyword">return</span> <span class="literal">false</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">ServiceMap</span> <span class="variable">smap</span> <span class="operator">=</span> getServiceMapLocked(r.userId);</span><br><span class="line">    <span class="keyword">if</span> (smap.mServicesByInstanceName.get(r.instanceName) != r) &#123; <span class="keyword">return</span> <span class="literal">false</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">long</span> <span class="variable">now</span> <span class="operator">=</span> SystemClock.uptimeMillis();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((r.serviceInfo.applicationInfo.flags</span><br><span class="line">            &amp;ApplicationInfo.FLAG_PERSISTENT) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// Any delivered but not yet finished starts should be put back</span></span><br><span class="line">        <span class="comment">// on the pending list.</span></span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">        ...... <span class="comment">// 设置 ServiceRecord 与重启服务相关变量，为服务启动加上延迟，防止大量服务同时启动</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Make sure that we don&#x27;t end up restarting a bunch of services</span></span><br><span class="line">        <span class="comment">// all at the same time.</span></span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Persistent processes are immediately restarted, so there is no</span></span><br><span class="line">        <span class="comment">// reason to hold of on restarting their services.</span></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!mRestartingServices.contains(r)) &#123;</span><br><span class="line">        r.createdFromFg = <span class="literal">false</span>;</span><br><span class="line">        mRestartingServices.add(r);</span><br><span class="line">        r.makeRestarting(mAm.mProcessStats.getMemFactorLocked(), now);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cancelForegroundNotificationLocked(r);</span><br><span class="line"></span><br><span class="line">    mAm.mHandler.removeCallbacks(r.restarter);</span><br><span class="line">    mAm.mHandler.postAtTime(r.restarter, r.nextRestartTime);</span><br><span class="line">    r.nextRestartTime = SystemClock.uptimeMillis() + r.restartDelay;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> canceled;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>排除系统关机和服务已存在的情形；</li>
<li>将已送达但未完成的 StartItem 放回 <code>mPendingStarts</code> 列表；</li>
<li>为服务启动加上延迟，防止扎堆启动；</li>
<li>将记录加入 <code>mRestartingServices</code> 列表；</li>
<li>将 ServiceRecord 的 <code>restarter</code> 成员 <code>post</code> 到 AMS 的 Handler，这是个实现了 Runnable 接口的 ServiceRestarter 对象，调用 <code>performServiceRestartLocked</code> 方法。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">ServiceRestarter</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> ServiceRecord mService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">setService</span><span class="params">(ServiceRecord service)</span> &#123;</span><br><span class="line">        mService = service;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span>(mAm) &#123;</span><br><span class="line">            performServiceRestartLocked(mService);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>performServiceRestartLocked</code> 方法调用 <code>bringUpServiceLocked</code> 启动服务。</p>
<h3 id="应用（重新）启动时带起服务"><a href="#应用（重新）启动时带起服务" class="headerlink" title="应用（重新）启动时带起服务"></a>应用（重新）启动时带起服务</h3><h4 id="attachApplicationLocked"><a href="#attachApplicationLocked" class="headerlink" title="attachApplicationLocked"></a><code>attachApplicationLocked</code></h4><p>应用启动后，<code>AMS.attachApplicationLocked</code> 调用 <code>ActiveServices.attachApplicationLocked</code> 方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">boolean</span> <span class="title function_">attachApplicationLocked</span><span class="params">(ProcessRecord proc, String processName)</span></span><br><span class="line">        <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">didSomething</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">// Collect any services that are waiting for this process to come up.</span></span><br><span class="line">    <span class="keyword">if</span> (mPendingServices.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">ServiceRecord</span> <span class="variable">sr</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i&lt;mPendingServices.size(); i++) &#123;</span><br><span class="line">                sr = mPendingServices.get(i);</span><br><span class="line">                <span class="keyword">if</span> (proc != sr.isolatedProc &amp;&amp; (proc.uid != sr.appInfo.uid</span><br><span class="line">                        || !processName.equals(sr.processName))) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                mPendingServices.remove(i);</span><br><span class="line">                i--;</span><br><span class="line">                proc.addPackage(sr.appInfo.packageName, sr.appInfo.longVersionCode,</span><br><span class="line">                        mAm.mProcessStats);</span><br><span class="line">                realStartServiceLocked(sr, proc, sr.createdFromFg);</span><br><span class="line">                didSomething = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">if</span> (!isServiceNeededLocked(sr, <span class="literal">false</span>, <span class="literal">false</span>)) &#123;</span><br><span class="line">                    <span class="comment">// We were waiting for this service to start, but it is actually no</span></span><br><span class="line">                    <span class="comment">// longer needed.  This could happen because bringDownServiceIfNeeded</span></span><br><span class="line">                    <span class="comment">// won&#x27;t bring down a service that is pending...  so now the pending</span></span><br><span class="line">                    <span class="comment">// is done, so let&#x27;s drop it.</span></span><br><span class="line">                    bringDownServiceLocked(sr);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123; <span class="keyword">throw</span> e; &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>遍历 <code>mPendingServices</code> 列表，找到进程名与当前启动进程名相同的 ServiceRecord，调用 <code>realStartServiceLocked</code> 启动该服务。如果判断当前启动服务不再需要，调用 <code>bringDownServiceLocked</code> 关闭之。</p>
<p>Q: <code>mPendingServices</code> 采用 ArrayList 存储是否影响查找效率？</p>
<p>Q: 为什么不前置判断，直接不启动不需要的服务？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">// Also, if there are any services that are waiting to restart and</span></span><br><span class="line">    <span class="comment">// would run in this process, now is a good time to start them.  It would</span></span><br><span class="line">    <span class="comment">// be weird to bring up the process but arbitrarily not let the services</span></span><br><span class="line">    <span class="comment">// run at this point just because their restart time hasn&#x27;t come up.</span></span><br><span class="line">    <span class="keyword">if</span> (mRestartingServices.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        ServiceRecord sr;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i&lt;mRestartingServices.size(); i++) &#123;</span><br><span class="line">            sr = mRestartingServices.get(i);</span><br><span class="line">            <span class="keyword">if</span> (proc != sr.isolatedProc &amp;&amp; (proc.uid != sr.appInfo.uid</span><br><span class="line">                    || !processName.equals(sr.processName))) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            mAm.mHandler.removeCallbacks(sr.restarter);</span><br><span class="line">            mAm.mHandler.post(sr.restarter);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> didSomething;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>遍历 <code>mRestartingServices</code> 列表，移除 AMS 的 Handler 中延时重启服务的消息，再重新添加立即启动服务的消息。</p>
<h1 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h1><ol>
<li>后台启动限制的梳理</li>
<li>数据结构的梳理</li>
<li>流程图</li>
</ol>
<h1 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h1><ol>
<li>服务概览 | Android 开发者, <a target="_blank" rel="noopener" href="https://developer.android.com/guide/components/services?hl=zh-cn">https://developer.android.com/guide/components/services?hl=zh-cn</a></li>
<li>Android系统源码分析–Service启动流程, <a target="_blank" rel="noopener" href="http://codemx.cn/2018/04/24/AndroidOS010-Service/">http://codemx.cn/2018/04/24/AndroidOS010-Service/</a></li>
</ol>
<h1 id="源代码"><a href="#源代码" class="headerlink" title="源代码"></a>源代码</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</span><br><span class="line">frameworks/base/services/core/java/com/android/server/am/ActiveServices.java</span><br><span class="line">frameworks/base/services/core/java/com/android/server/am/ServiceRecord.java</span><br><span class="line">frameworks/base/services/core/java/com/android/server/am/ConnectionRecord.java</span><br><span class="line">frameworks/base/services/core/java/com/android/server/am/ProcessRecord.java</span><br><span class="line"></span><br><span class="line">frameworks/base/core/java/android/app/ContextImpl.java</span><br><span class="line">frameworks/base/core/java/android/app/ActivityThread.java</span><br><span class="line">frameworks/base/core/java/android/app/LoadedApk.java</span><br></pre></td></tr></table></figure>
    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Android/" rel="tag"># Android</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/posts/3663140717/" rel="prev" title="ContentProvider 源码分析">
      <i class="fa fa-chevron-left"></i> ContentProvider 源码分析
    </a></div>
      <div class="post-nav-item">
    <a href="/posts/2137979396/" rel="next" title="Android 应用组件源码分析 PPT 分享">
      Android 应用组件源码分析 PPT 分享 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="gitalk-container"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Android-Service-%E7%AE%80%E4%BB%8B"><span class="nav-text">Android Service 简介</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E6%9C%8D%E5%8A%A1"><span class="nav-text">创建服务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BB%91%E5%AE%9A%E5%88%B0%E6%9C%8D%E5%8A%A1"><span class="nav-text">绑定到服务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="nav-text">服务生命周期</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-text">源码分析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Service-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B"><span class="nav-text">Service 启动流程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#startServiceLocked"><span class="nav-text">startServiceLocked</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#startServiceInnerLocked"><span class="nav-text">startServiceInnerLocked</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#bringUpServiceLocked"><span class="nav-text">bringUpServiceLocked</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#realStartServiceLocked"><span class="nav-text">realStartServiceLocked</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ActivityThread-handleCreateService"><span class="nav-text">ActivityThread.handleCreateService</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#sendServiceArgsLocked"><span class="nav-text">sendServiceArgsLocked</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ActivityThread-handleServiceArgs"><span class="nav-text">ActivityThread.handleServiceArgs</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#bumpServiceExecutingLocked"><span class="nav-text">bumpServiceExecutingLocked</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#serviceDoneExecutingLocked"><span class="nav-text">serviceDoneExecutingLocked</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Service-%E7%BB%91%E5%AE%9A%E6%B5%81%E7%A8%8B"><span class="nav-text">Service 绑定流程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#bindServiceCommon"><span class="nav-text">bindServiceCommon</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#LoadedApk-getServiceDispatcher"><span class="nav-text">LoadedApk.getServiceDispatcher</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#bindServiceLocked"><span class="nav-text">bindServiceLocked</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#requestServiceBindingLocked"><span class="nav-text">requestServiceBindingLocked</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ActivityThread-handleBindService"><span class="nav-text">ActivityThread.handleBindService</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#publishServiceLocked"><span class="nav-text">publishServiceLocked</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#LoadedApk-ServiceDispatcher-connected"><span class="nav-text">LoadedApk.ServiceDispatcher.connected</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#LoadedApk-ServiceDispatcher-doConnected"><span class="nav-text">LoadedApk.ServiceDispatcher.doConnected</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Service-%E8%A7%A3%E7%BB%91%E6%B5%81%E7%A8%8B"><span class="nav-text">Service 解绑流程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ActiveServices-unbindServiceLocked"><span class="nav-text">ActiveServices.unbindServiceLocked</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ActiveServices-removeConnectionLocked"><span class="nav-text">ActiveServices.removeConnectionLocked</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ActivityThread-handleUnbindService"><span class="nav-text">ActivityThread.handleUnbindService</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ActiveServices-unbindFinishedLocked"><span class="nav-text">ActiveServices.unbindFinishedLocked</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AMS-stopAssociationLocked"><span class="nav-text">AMS.stopAssociationLocked</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Service-%E5%81%9C%E6%AD%A2%E6%B5%81%E7%A8%8B"><span class="nav-text">Service 停止流程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E5%81%9C%E6%AD%A2%E7%9A%84%E6%96%B9%E5%BC%8F"><span class="nav-text">服务停止的方式</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%B0%83%E7%94%A8-stopService-%E5%81%9C%E6%AD%A2%E6%9C%8D%E5%8A%A1"><span class="nav-text">调用 stopService 停止服务</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%B0%83%E7%94%A8-unbindService-%E8%A7%A3%E7%BB%91%E6%9C%80%E5%90%8E%E4%B8%80%E4%B8%AA%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="nav-text">调用 unbindService 解绑最后一个客户端</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E8%B0%83%E7%94%A8-stopSelf-%E5%81%9C%E6%AD%A2"><span class="nav-text">服务调用 stopSelf 停止</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#bringDownServiceIfNeededLocked"><span class="nav-text">bringDownServiceIfNeededLocked</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#isServiceNeededLocked"><span class="nav-text">isServiceNeededLocked</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ServiceRecord-hasAutoCreateConnection"><span class="nav-text">ServiceRecord.hasAutoCreateConnection</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#bringDownServiceLocked"><span class="nav-text">bringDownServiceLocked</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ActivityThread-handleStopService"><span class="nav-text">ActivityThread.handleStopService</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Service-%E8%A2%AB%E6%9D%80%E9%87%8D%E6%96%B0%E5%90%AF%E5%8A%A8%E7%9A%84%E6%B5%81%E7%A8%8B"><span class="nav-text">Service 被杀重新启动的流程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BA%94%E7%94%A8%E8%A2%AB%E6%9D%80%E7%9A%84%E5%9B%9E%E8%B0%83"><span class="nav-text">应用被杀的回调</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#killServicesLocked"><span class="nav-text">killServicesLocked</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AMS-%E5%8F%91%E8%B5%B7%E9%87%8D%E5%90%AF%E6%9C%8D%E5%8A%A1"><span class="nav-text">AMS 发起重启服务</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#scheduleServiceRestartLocked"><span class="nav-text">scheduleServiceRestartLocked</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BA%94%E7%94%A8%EF%BC%88%E9%87%8D%E6%96%B0%EF%BC%89%E5%90%AF%E5%8A%A8%E6%97%B6%E5%B8%A6%E8%B5%B7%E6%9C%8D%E5%8A%A1"><span class="nav-text">应用（重新）启动时带起服务</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#attachApplicationLocked"><span class="nav-text">attachApplicationLocked</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#TODO"><span class="nav-text">TODO</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><span class="nav-text">参考文献</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%BA%90%E4%BB%A3%E7%A0%81"><span class="nav-text">源代码</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">solarqiang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">10</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/solarqiang" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;solarqiang" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:zhiqiang.sol@foxmail.com" title="E-Mail → mailto:zhiqiang.sol@foxmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i></a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">solarqiang</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div>

        






<script>
  (function() {
    function leancloudSelector(url) {
      url = encodeURI(url);
      return document.getElementById(url).querySelector('.leancloud-visitors-count');
    }

    function addCount(Counter) {
      var visitors = document.querySelector('.leancloud_visitors');
      var url = decodeURI(visitors.id);
      var title = visitors.dataset.flagTitle;

      Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({ url })))
        .then(response => response.json())
        .then(({ results }) => {
          if (results.length > 0) {
            var counter = results[0];
            leancloudSelector(url).innerText = counter.time + 1;
            Counter('put', '/classes/Counter/' + counter.objectId, { time: { '__op': 'Increment', 'amount': 1 } })
              .catch(error => {
                console.error('Failed to save visitor count', error);
              });
          } else {
              leancloudSelector(url).innerText = 'Counter not initialized! More info at console err msg.';
              console.error('ATTENTION! LeanCloud counter has security bug, see how to solve it here: https://github.com/theme-next/hexo-leancloud-counter-security. \n However, you can still use LeanCloud without security, by setting `security` option to `false`.');
            
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }

    function showTime(Counter) {
      var visitors = document.querySelectorAll('.leancloud_visitors');
      var entries = [...visitors].map(element => {
        return decodeURI(element.id);
      });

      Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({ url: { '$in': entries } })))
        .then(response => response.json())
        .then(({ results }) => {
          for (let url of entries) {
            let target = results.find(item => item.url === url);
            leancloudSelector(url).innerText = target ? target.time : 0;
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }

    let { app_id, app_key, server_url } = {"enable":true,"app_id":"bbnDMngYAJzVwwnYmQY3Rpm4-MdYXbMMI","app_key":"19WWCYLnVoXolUN0qqs73zX1","security":true,"betterPerformance":true};
    function fetchData(api_server) {
      var Counter = (method, url, data) => {
        return fetch(`${api_server}/1.1${url}`, {
          method,
          headers: {
            'X-LC-Id'     : app_id,
            'X-LC-Key'    : app_key,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });
      };
      if (CONFIG.page.isPost) {
        if (CONFIG.hostname !== location.hostname) return;
        addCount(Counter);
      } else if (document.querySelectorAll('.post-title-link').length >= 1) {
        showTime(Counter);
      }
    }

    let api_server = app_id.slice(-9) !== '-MdYXbMMI' ? server_url : `https://${app_id.slice(0, 8).toLowerCase()}.api.lncldglobal.com`;

    if (api_server) {
      fetchData(api_server);
    } else {
      fetch('https://app-router.leancloud.cn/2/route?appId=' + app_id)
        .then(response => response.json())
        .then(({ api_server }) => {
          fetchData('https://' + api_server);
        });
    }
  })();
</script>


      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : 'f7b603007e72448a85b0',
      clientSecret: 'a8354c5d4cc087aef62a729d4c69750b38cd2ad4',
      repo        : 'solarqiang.github.io',
      owner       : 'solarqiang',
      admin       : ['solarqiang'],
      id          : '617aeb65f6c33dd39b35a0d4b8477f08',
        language: 'zh-CN',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script>

</body>
</html>
